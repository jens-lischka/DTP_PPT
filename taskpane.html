<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    
    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Fluent UI Icons -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>
    
    <style>
        :root {
            --primary: #0078d4;
            --primary-hover: #106ebe;
            --primary-pressed: #005a9e;
            --success: #107c10;
            --warning: #ffaa44;
            --danger: #d13438;
            --neutral-bg: #faf9f8;
            --neutral-lighter: #f3f2f1;
            --neutral-light: #edebe9;
            --neutral-dark: #605e5c;
            --neutral-darker: #323130;
            --white: #ffffff;
            --shadow-sm: 0 1.6px 3.6px rgba(0,0,0,0.13), 0 0.3px 0.9px rgba(0,0,0,0.11);
            --shadow-md: 0 3.2px 7.2px rgba(0,0,0,0.13), 0 0.6px 1.8px rgba(0,0,0,0.11);
            --radius: 4px;
            --radius-lg: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--neutral-darker);
            background: var(--neutral-bg);
            min-height: 100vh;
        }

        .taskpane {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--neutral-light);
        }

        .header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #50e6ff);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header-text h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .header-text p {
            font-size: 12px;
            color: var(--neutral-dark);
        }

        /* API Key Section */
        .api-key-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 12px;
            box-shadow: var(--shadow-sm);
        }

        .api-key-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .api-key-header label {
            font-size: 12px;
            font-weight: 600;
            color: var(--neutral-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .api-key-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .api-key-status.connected {
            background: #dff6dd;
            color: var(--success);
        }

        .api-key-status.disconnected {
            background: #fed9cc;
            color: var(--danger);
        }

        .api-key-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .api-key-input-wrapper input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: 'Consolas', monospace;
            transition: border-color 0.15s;
        }

        .api-key-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-save-key {
            padding: 8px 16px;
            background: var(--neutral-lighter);
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-save-key:hover {
            background: var(--neutral-light);
        }

        /* Prompt Section */
        .prompt-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .prompt-section label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--neutral-darker);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.15s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .prompt-textarea::placeholder {
            color: var(--neutral-dark);
        }

        /* Options */
        .options-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .option-group {
            flex: 1;
        }

        .option-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--neutral-dark);
            margin-bottom: 4px;
        }

        .option-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            background: var(--white);
            cursor: pointer;
        }

        .option-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Generate Button */
        .btn-generate {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.15s;
            margin-top: 12px;
        }

        .btn-generate:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-generate:active:not(:disabled) {
            background: var(--primary-pressed);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-generate .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Shape Info */
        .shape-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin-top: 12px;
            background: var(--neutral-lighter);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--neutral-dark);
        }

        .shape-info.detected {
            background: #e7f3ff;
            color: var(--primary);
        }

        .shape-info i {
            font-size: 14px;
        }

        /* Preview Section */
        .preview-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            display: none;
        }

        .preview-section.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .preview-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .preview-image-container {
            position: relative;
            background: var(--neutral-lighter);
            border-radius: var(--radius);
            overflow: hidden;
            aspect-ratio: 1;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .preview-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--neutral-lighter);
        }

        .preview-loading .spinner-large {
            width: 40px;
            height: 40px;
            border: 3px solid var(--neutral-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .preview-loading p {
            font-size: 13px;
            color: var(--neutral-dark);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-action {
            flex: 1;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .btn-regenerate {
            background: var(--white);
            border: 1px solid var(--neutral-light);
            color: var(--neutral-darker);
        }

        .btn-regenerate:hover {
            background: var(--neutral-lighter);
        }

        .btn-insert {
            background: var(--success);
            border: 1px solid var(--success);
            color: white;
        }

        .btn-insert:hover {
            background: #0b5c0b;
        }

        /* Insert Options */
        .insert-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .insert-option {
            flex: 1;
            padding: 8px;
            background: var(--neutral-lighter);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .insert-option:hover {
            background: var(--neutral-light);
        }

        .insert-option.selected {
            border-color: var(--primary);
            background: #e7f3ff;
        }

        .insert-option i {
            display: block;
            font-size: 20px;
            margin-bottom: 4px;
            color: var(--neutral-dark);
        }

        .insert-option.selected i {
            color: var(--primary);
        }

        .insert-option span {
            font-size: 11px;
            color: var(--neutral-dark);
        }

        /* Status Messages */
        .status-message {
            padding: 10px 12px;
            border-radius: var(--radius);
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .status-message.visible {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .status-message.success {
            background: #dff6dd;
            color: var(--success);
        }

        .status-message.error {
            background: #fed9cc;
            color: var(--danger);
        }

        .status-message.info {
            background: #e7f3ff;
            color: var(--primary);
        }

        /* History Section */
        .history-section {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--neutral-light);
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-header h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--neutral-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-clear-history {
            font-size: 11px;
            color: var(--neutral-dark);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .history-item {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .history-item:hover {
            border-color: var(--primary);
        }

        .history-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .history-empty {
            text-align: center;
            padding: 16px;
            color: var(--neutral-dark);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="taskpane">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">
                <i class="ms-Icon ms-Icon--ImagePixel"></i>
            </div>
            <div class="header-text">
                <h1>AI Image Generator</h1>
                <p>Powered by OpenAI DALL-E</p>
            </div>
        </div>

        <!-- API Key Section -->
        <div class="api-key-section">
            <div class="api-key-header">
                <label>OpenAI API Key</label>
                <span id="apiKeyStatus" class="api-key-status disconnected">Not Set</span>
            </div>
            <div class="api-key-input-wrapper">
                <input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
                <button class="btn-save-key" id="btnSaveKey">Save</button>
            </div>
        </div>

        <!-- Prompt Section -->
        <div class="prompt-section">
            <label for="promptInput">Describe your image</label>
            <textarea 
                id="promptInput" 
                class="prompt-textarea" 
                placeholder="A serene mountain landscape at sunset with golden light reflecting off a calm lake..."
            ></textarea>
            
            <div class="options-row">
                <div class="option-group">
                    <label>Size</label>
                    <select id="sizeSelect">
                        <option value="auto">Auto (from selection)</option>
                        <option value="1024x1024">Square (1024×1024)</option>
                        <option value="1792x1024">Landscape (1792×1024)</option>
                        <option value="1024x1792">Portrait (1024×1792)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Quality</label>
                    <select id="qualitySelect">
                        <option value="standard">Standard</option>
                        <option value="hd">HD</option>
                    </select>
                </div>
            </div>
            
            <div id="shapeInfo" class="shape-info">
                <i class="ms-Icon ms-Icon--RectangleShape"></i>
                <span id="shapeInfoText">No shape selected - will use size setting</span>
            </div>
            
            <button class="btn-generate" id="btnGenerate" disabled>
                <i class="ms-Icon ms-Icon--Rocket"></i>
                <span>Generate Image</span>
            </button>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message">
            <i class="ms-Icon"></i>
            <span></span>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="preview-section">
            <div class="preview-header">
                <h2>Generated Image</h2>
            </div>
            
            <div class="preview-image-container">
                <div id="previewLoading" class="preview-loading">
                    <div class="spinner-large"></div>
                    <p>Generating your image...</p>
                </div>
                <img id="previewImage" class="preview-image" alt="Generated image preview">
            </div>
            
            <div class="insert-options">
                <div class="insert-option selected" data-mode="auto">
                    <i class="ms-Icon ms-Icon--AutoFit"></i>
                    <span>Auto Detect</span>
                </div>
                <div class="insert-option" data-mode="slide">
                    <i class="ms-Icon ms-Icon--Presentation"></i>
                    <span>On Slide</span>
                </div>
                <div class="insert-option" data-mode="fill">
                    <i class="ms-Icon ms-Icon--RectangleShape"></i>
                    <span>Fill Shape</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn-action btn-regenerate" id="btnRegenerate">
                    <i class="ms-Icon ms-Icon--Refresh"></i>
                    Regenerate
                </button>
                <button class="btn-action btn-insert" id="btnInsert">
                    <i class="ms-Icon ms-Icon--CheckMark"></i>
                    Insert
                </button>
            </div>
        </div>

        <!-- History Section -->
        <div class="history-section">
            <div class="history-header">
                <h3>Recent Images</h3>
                <button class="btn-clear-history" id="btnClearHistory">Clear</button>
            </div>
            <div id="historyGrid" class="history-grid">
                <div class="history-empty">No images generated yet</div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // State Management
        // ======================
        const state = {
            apiKey: '',
            currentImageUrl: null,
            currentImageBase64: null,
            currentImageSize: '1024x1024',
            insertMode: 'auto',
            history: [],
            isGenerating: false,
            selectedShape: null  // { width, height, aspectRatio, name }
        };

        // ======================
        // DOM Elements
        // ======================
        const elements = {
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            btnSaveKey: document.getElementById('btnSaveKey'),
            promptInput: document.getElementById('promptInput'),
            sizeSelect: document.getElementById('sizeSelect'),
            qualitySelect: document.getElementById('qualitySelect'),
            btnGenerate: document.getElementById('btnGenerate'),
            statusMessage: document.getElementById('statusMessage'),
            previewSection: document.getElementById('previewSection'),
            previewLoading: document.getElementById('previewLoading'),
            previewImage: document.getElementById('previewImage'),
            btnRegenerate: document.getElementById('btnRegenerate'),
            btnInsert: document.getElementById('btnInsert'),
            historyGrid: document.getElementById('historyGrid'),
            btnClearHistory: document.getElementById('btnClearHistory'),
            insertOptions: document.querySelectorAll('.insert-option'),
            shapeInfo: document.getElementById('shapeInfo'),
            shapeInfoText: document.getElementById('shapeInfoText')
        };

        // ======================
        // Office.js Initialization
        // ======================
        Office.onReady((info) => {
            if (info.host === Office.HostType.PowerPoint) {
                initializeApp();
            }
        });

        function initializeApp() {
            // Load saved API key from localStorage
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                state.apiKey = savedKey;
                elements.apiKeyInput.value = '••••••••••••••••';
                updateApiKeyStatus(true);
            }

            // Load history
            const savedHistory = localStorage.getItem('image_history');
            if (savedHistory) {
                state.history = JSON.parse(savedHistory);
                renderHistory();
            }

            // Setup event listeners
            setupEventListeners();
            updateGenerateButton();
        }

        function setupEventListeners() {
            // API Key
            elements.btnSaveKey.addEventListener('click', saveApiKey);
            elements.apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveApiKey();
            });

            // Generate
            elements.btnGenerate.addEventListener('click', generateImage);
            elements.promptInput.addEventListener('input', updateGenerateButton);

            // Preview actions
            elements.btnRegenerate.addEventListener('click', generateImage);
            elements.btnInsert.addEventListener('click', insertImage);

            // Insert mode selection
            elements.insertOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.insertOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.insertMode = option.dataset.mode;
                });
            });

            // History
            elements.btnClearHistory.addEventListener('click', clearHistory);

            // Start monitoring selection changes
            detectSelectedShape();
            // Poll for selection changes (Office.js doesn't have a reliable selection change event for shapes)
            setInterval(detectSelectedShape, 1000);
        }

        // ======================
        // Shape Detection
        // ======================
        async function detectSelectedShape() {
            try {
                await PowerPoint.run(async (context) => {
                    const shapes = context.presentation.getSelectedShapes();
                    shapes.load('items');
                    await context.sync();

                    if (shapes.items.length > 0) {
                        const shape = shapes.items[0];
                        shape.load(['width', 'height', 'name', 'type']);
                        await context.sync();

                        const width = shape.width;
                        const height = shape.height;
                        const aspectRatio = width / height;
                        const name = shape.name;

                        state.selectedShape = {
                            width: width,
                            height: height,
                            aspectRatio: aspectRatio,
                            name: name
                        };

                        // Determine best DALL-E size based on aspect ratio
                        const dalleSize = getBestDalleSize(aspectRatio);
                        
                        // Update UI
                        elements.shapeInfo.classList.add('detected');
                        elements.shapeInfoText.textContent = `${name} selected (${Math.round(width)}×${Math.round(height)}pt) → ${dalleSize}`;
                    } else {
                        state.selectedShape = null;
                        elements.shapeInfo.classList.remove('detected');
                        elements.shapeInfoText.textContent = 'No shape selected - will use size setting';
                    }
                });
            } catch (error) {
                // Silently fail - shape detection is optional
                state.selectedShape = null;
            }
        }

        // Get the best DALL-E size based on aspect ratio
        function getBestDalleSize(aspectRatio) {
            // DALL-E 3 supported sizes:
            // 1024x1024 (1:1, ratio = 1.0)
            // 1792x1024 (landscape, ratio ≈ 1.75)
            // 1024x1792 (portrait, ratio ≈ 0.57)
            
            if (aspectRatio > 1.35) {
                return '1792x1024';  // Landscape
            } else if (aspectRatio < 0.75) {
                return '1024x1792';  // Portrait
            } else {
                return '1024x1024';  // Square
            }
        }

        // Get the size to use for generation
        function getGenerationSize() {
            const selectedSize = elements.sizeSelect.value;
            
            if (selectedSize === 'auto') {
                if (state.selectedShape) {
                    return getBestDalleSize(state.selectedShape.aspectRatio);
                } else {
                    return '1024x1024';  // Default to square
                }
            }
            
            return selectedSize;
        }

        // ======================
        // API Key Management
        // ======================
        function saveApiKey() {
            const key = elements.apiKeyInput.value.trim();
            if (key && key !== '••••••••••••••••') {
                state.apiKey = key;
                localStorage.setItem('openai_api_key', key);
                elements.apiKeyInput.value = '••••••••••••••••';
                updateApiKeyStatus(true);
                showStatus('API key saved successfully', 'success');
            }
            updateGenerateButton();
        }

        function updateApiKeyStatus(isSet) {
            if (isSet) {
                elements.apiKeyStatus.textContent = 'Connected';
                elements.apiKeyStatus.className = 'api-key-status connected';
            } else {
                elements.apiKeyStatus.textContent = 'Not Set';
                elements.apiKeyStatus.className = 'api-key-status disconnected';
            }
        }

        // ======================
        // Image Generation
        // ======================
        async function generateImage() {
            const prompt = elements.promptInput.value.trim();
            if (!prompt || !state.apiKey || state.isGenerating) return;

            state.isGenerating = true;
            updateGenerateButton();
            
            // Show preview section with loading
            elements.previewSection.classList.add('visible');
            elements.previewLoading.style.display = 'flex';
            elements.previewImage.style.display = 'none';
            
            showStatus(`Generating ${getGenerationSize()} image...`, 'info');

            try {
                const generationSize = getGenerationSize();
                
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'dall-e-3',
                        prompt: prompt,
                        n: 1,
                        size: generationSize,
                        quality: elements.qualitySelect.value,
                        response_format: 'b64_json'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Failed to generate image');
                }

                const data = await response.json();
                const base64Data = data.data[0].b64_json;
                const imageUrl = `data:image/png;base64,${base64Data}`;

                state.currentImageUrl = imageUrl;
                state.currentImageBase64 = base64Data;
                state.currentImageSize = generationSize;

                // Display the image
                elements.previewImage.src = imageUrl;
                elements.previewImage.style.display = 'block';
                elements.previewLoading.style.display = 'none';

                // Add to history
                addToHistory(imageUrl, prompt, generationSize);

                showStatus('Image generated successfully!', 'success');
            } catch (error) {
                console.error('Generation error:', error);
                showStatus(error.message || 'Failed to generate image', 'error');
                elements.previewLoading.style.display = 'none';
            } finally {
                state.isGenerating = false;
                updateGenerateButton();
            }
        }

        // ======================
        // Insert Image into PowerPoint
        // ======================
        async function insertImage() {
            if (!state.currentImageBase64) {
                showStatus('No image to insert', 'error');
                return;
            }

            showStatus('Inserting image...', 'info');

            // Calculate dimensions - use shape size if available, otherwise calculate from image ratio
            let imgWidth, imgHeight;
            
            if (state.selectedShape && (state.insertMode === 'auto' || state.insertMode === 'fill')) {
                // Use the selected shape's exact dimensions
                imgWidth = state.selectedShape.width;
                imgHeight = state.selectedShape.height;
            } else {
                // Calculate from the current image's generation size
                const size = state.currentImageSize.split('x');
                const width = parseInt(size[0]);
                const height = parseInt(size[1]);
                const aspectRatio = width / height;
                const maxWidth = 400;
                imgWidth = maxWidth;
                imgHeight = maxWidth / aspectRatio;
            }

            // Mode: "slide" - always insert freely on slide
            if (state.insertMode === 'slide') {
                insertImageOnSlide(imgWidth, imgHeight);
                return;
            }

            // Mode: "fill" - fill selected shape as background
            if (state.insertMode === 'fill') {
                await fillSelectedShape();
                return;
            }

            // Mode: "auto" - detect what's selected and act accordingly
            try {
                await PowerPoint.run(async (context) => {
                    const shapes = context.presentation.getSelectedShapes();
                    shapes.load('items');
                    await context.sync();

                    if (shapes.items.length > 0) {
                        const shape = shapes.items[0];
                        // Load shape properties to detect type
                        shape.load(['type', 'name']);
                        await context.sync();

                        const shapeName = shape.name.toLowerCase();
                        const shapeType = shape.type;

                        console.log('Selected shape:', shapeType, shapeName);

                        // Check if it's a content placeholder or picture placeholder
                        // Placeholder names often contain "Content", "Picture", "Media", etc.
                        const isContentPlaceholder = 
                            shapeName.includes('content') ||
                            shapeName.includes('picture') ||
                            shapeName.includes('media') ||
                            shapeName.includes('placeholder') ||
                            shapeType === 'Placeholder';

                        if (isContentPlaceholder) {
                            // Insert INTO the placeholder (like pasting an image)
                            // Using setSelectedDataAsync while placeholder is selected
                            insertImageOnSlide(imgWidth, imgHeight);
                        } else {
                            // Regular shape - fill it as background
                            await fillSelectedShape();
                        }
                    } else {
                        // Nothing selected - insert freely on slide
                        insertImageOnSlide(imgWidth, imgHeight);
                    }
                });
            } catch (error) {
                console.error('Auto-detect error:', error);
                // Fallback to simple insert
                insertImageOnSlide(imgWidth, imgHeight);
            }
        }

        // Helper: Insert image freely on slide (or into selected placeholder)
        function insertImageOnSlide(imgWidth, imgHeight) {
            Office.context.document.setSelectedDataAsync(
                state.currentImageBase64,
                {
                    coercionType: Office.CoercionType.Image,
                    imageWidth: imgWidth,
                    imageHeight: imgHeight
                },
                function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        showStatus('Image inserted!', 'success');
                    } else {
                        console.error('Insert error:', result.error);
                        showStatus('Failed to insert: ' + result.error.message, 'error');
                    }
                }
            );
        }

        // Helper: Fill selected shape with image as background
        async function fillSelectedShape() {
            try {
                await PowerPoint.run(async (context) => {
                    const shapes = context.presentation.getSelectedShapes();
                    shapes.load('items');
                    await context.sync();

                    if (shapes.items.length > 0) {
                        const shape = shapes.items[0];
                        shape.fill.setImage(state.currentImageBase64);
                        await context.sync();
                        showStatus('Image applied as shape fill!', 'success');
                    } else {
                        showStatus('Please select a shape first', 'error');
                    }
                });
            } catch (error) {
                console.error('Shape fill error:', error);
                showStatus('Failed to fill shape: ' + error.message, 'error');
            }
        }

        // ======================
        // History Management
        // ======================
        function addToHistory(imageUrl, prompt, size = '1024x1024') {
            state.history.unshift({
                url: imageUrl,
                prompt: prompt,
                size: size,
                timestamp: Date.now()
            });

            // Keep only last 8 images
            if (state.history.length > 8) {
                state.history = state.history.slice(0, 8);
            }

            localStorage.setItem('image_history', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyGrid.innerHTML = '<div class="history-empty">No images generated yet</div>';
                return;
            }

            elements.historyGrid.innerHTML = state.history.map((item, index) => `
                <div class="history-item" data-index="${index}" title="${item.prompt}">
                    <img src="${item.url}" alt="Generated image">
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    loadFromHistory(index);
                });
            });
        }

        function loadFromHistory(index) {
            const item = state.history[index];
            if (item) {
                state.currentImageUrl = item.url;
                // Extract base64 from data URL
                state.currentImageBase64 = item.url.split(',')[1];
                state.currentImageSize = item.size || '1024x1024';
                
                elements.previewImage.src = item.url;
                elements.previewImage.style.display = 'block';
                elements.previewLoading.style.display = 'none';
                elements.previewSection.classList.add('visible');
                
                elements.promptInput.value = item.prompt;
                showStatus('Image loaded from history', 'info');
            }
        }

        function clearHistory() {
            state.history = [];
            localStorage.removeItem('image_history');
            renderHistory();
            showStatus('History cleared', 'info');
        }

        // ======================
        // UI Helpers
        // ======================
        function updateGenerateButton() {
            const hasPrompt = elements.promptInput.value.trim().length > 0;
            const hasApiKey = state.apiKey.length > 0;
            
            elements.btnGenerate.disabled = !hasPrompt || !hasApiKey || state.isGenerating;
            
            if (state.isGenerating) {
                elements.btnGenerate.innerHTML = `
                    <div class="spinner"></div>
                    <span>Generating...</span>
                `;
            } else {
                elements.btnGenerate.innerHTML = `
                    <i class="ms-Icon ms-Icon--Rocket"></i>
                    <span>Generate Image</span>
                `;
            }
        }

        function showStatus(message, type) {
            const icon = type === 'success' ? 'CheckMark' : 
                        type === 'error' ? 'ErrorBadge' : 'Info';
            
            elements.statusMessage.innerHTML = `
                <i class="ms-Icon ms-Icon--${icon}"></i>
                <span>${message}</span>
            `;
            elements.statusMessage.className = `status-message visible ${type}`;
            
            // Auto-hide success messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    elements.statusMessage.classList.remove('visible');
                }, 3000);
            }
        }
    </script>
</body>
</html>
