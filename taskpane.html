<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    
    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Fluent UI Icons -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>
    
    <style>
        :root {
            --primary: #0078d4;
            --primary-hover: #106ebe;
            --primary-pressed: #005a9e;
            --success: #107c10;
            --warning: #ffaa44;
            --danger: #d13438;
            --neutral-bg: #faf9f8;
            --neutral-lighter: #f3f2f1;
            --neutral-light: #edebe9;
            --neutral-dark: #605e5c;
            --neutral-darker: #323130;
            --white: #ffffff;
            --shadow-sm: 0 1.6px 3.6px rgba(0,0,0,0.13), 0 0.3px 0.9px rgba(0,0,0,0.11);
            --shadow-md: 0 3.2px 7.2px rgba(0,0,0,0.13), 0 0.6px 1.8px rgba(0,0,0,0.11);
            --radius: 4px;
            --radius-lg: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--neutral-darker);
            background: var(--neutral-bg);
            min-height: 100vh;
        }

        .taskpane {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            border-bottom: 1px solid var(--neutral-light);
            background: var(--white);
        }

        .header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #50e6ff);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header-text h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .header-text p {
            font-size: 12px;
            color: var(--neutral-dark);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--neutral-light);
            padding: 0 8px;
        }

        .tab {
            flex: 1;
            padding: 10px 4px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 11px;
            font-weight: 500;
            color: var(--neutral-dark);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab i {
            font-size: 16px;
        }

        .tab:hover {
            color: var(--primary);
            background: var(--neutral-lighter);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* API Key Section */
        .api-key-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 12px;
            box-shadow: var(--shadow-sm);
        }

        .api-key-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .api-key-header label {
            font-size: 12px;
            font-weight: 600;
            color: var(--neutral-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .api-key-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .api-key-status.connected {
            background: #dff6dd;
            color: var(--success);
        }

        .api-key-status.disconnected {
            background: #fed9cc;
            color: var(--danger);
        }

        .api-key-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .api-key-input-wrapper input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: 'Consolas', monospace;
            transition: border-color 0.15s;
        }

        .api-key-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-save-key {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-save-key:hover {
            background: var(--primary-hover);
        }

        .btn-save-key:active {
            background: var(--primary-pressed);
        }

        /* Prompt Section */
        .prompt-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .prompt-section label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--neutral-darker);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.15s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .prompt-textarea::placeholder {
            color: var(--neutral-dark);
        }

        /* Style Presets */
        .style-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .style-preset {
            padding: 6px 12px;
            background: var(--neutral-lighter);
            border: 1px solid var(--neutral-light);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .style-preset:hover {
            background: var(--neutral-light);
        }

        .style-preset.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Options */
        .options-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .option-group {
            flex: 1;
        }

        .option-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--neutral-dark);
            margin-bottom: 4px;
            display: block;
        }

        .option-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            background: var(--white);
            cursor: pointer;
        }

        .option-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Generate Button */
        .btn-generate {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.15s;
            margin-top: 12px;
        }

        .btn-generate:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-generate:active:not(:disabled) {
            background: var(--primary-pressed);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-generate .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Shape Info */
        .shape-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin-top: 12px;
            background: var(--neutral-lighter);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--neutral-dark);
        }

        .shape-info.detected {
            background: #e7f3ff;
            color: var(--primary);
        }

        .shape-info i {
            font-size: 14px;
        }

        /* Preview Section */
        .preview-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            display: none;
        }

        .preview-section.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .preview-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .preview-image-container {
            position: relative;
            background: var(--neutral-lighter);
            border-radius: var(--radius);
            overflow: hidden;
            aspect-ratio: 1;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .preview-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--neutral-lighter);
        }

        .preview-loading .spinner-large {
            width: 40px;
            height: 40px;
            border: 3px solid var(--neutral-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .preview-loading p {
            font-size: 13px;
            color: var(--neutral-dark);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-action {
            flex: 1;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .btn-regenerate {
            background: var(--white);
            border: 1px solid var(--neutral-light);
            color: var(--neutral-darker);
        }

        .btn-regenerate:hover {
            background: var(--neutral-lighter);
        }

        .btn-insert {
            background: var(--success);
            border: 1px solid var(--success);
            color: white;
        }

        .btn-insert:hover {
            background: #0b5c0b;
        }

        /* Insert Options */
        .insert-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .insert-option {
            flex: 1;
            padding: 8px;
            background: var(--neutral-lighter);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .insert-option:hover {
            background: var(--neutral-light);
        }

        .insert-option.selected {
            border-color: var(--primary);
            background: #e7f3ff;
        }

        .insert-option i {
            display: block;
            font-size: 20px;
            margin-bottom: 4px;
            color: var(--neutral-dark);
        }

        .insert-option.selected i {
            color: var(--primary);
        }

        .insert-option span {
            font-size: 11px;
            color: var(--neutral-dark);
        }

        /* Status Messages */
        .status-message {
            padding: 10px 12px;
            border-radius: var(--radius);
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .status-message.visible {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .status-message.success {
            background: #dff6dd;
            color: var(--success);
        }

        .status-message.error {
            background: #fed9cc;
            color: var(--danger);
        }

        .status-message.info {
            background: #e7f3ff;
            color: var(--primary);
        }

        /* History Section */
        .history-section {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--neutral-light);
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-header h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--neutral-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-clear-history {
            font-size: 11px;
            color: var(--neutral-dark);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .history-item {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .history-item:hover {
            border-color: var(--primary);
        }

        .history-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .history-empty {
            text-align: center;
            padding: 16px;
            color: var(--neutral-dark);
            font-size: 12px;
        }

        /* Feedback Tab Styles */
        .feedback-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .feedback-section h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--neutral-darker);
        }

        .feedback-section p {
            font-size: 13px;
            color: var(--neutral-dark);
            margin-bottom: 12px;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-submit-feedback {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-submit-feedback:hover {
            background: var(--primary-hover);
        }

        .feedback-info {
            margin-top: 16px;
            padding: 12px;
            background: var(--neutral-lighter);
            border-radius: var(--radius);
        }

        .feedback-info h3 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--neutral-darker);
        }

        .feedback-info a {
            color: var(--primary);
            text-decoration: none;
        }

        .feedback-info a:hover {
            text-decoration: underline;
        }

        /* SlideWiki Tab Styles */
        .slides-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .slide-file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--neutral-lighter);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }

        .slide-file-item:hover {
            background: var(--neutral-light);
        }

        .slide-file-item.selected {
            border-color: var(--primary);
            background: #e7f3ff;
        }

        .slide-file-item i {
            font-size: 24px;
            color: #d04423;
        }

        .slide-file-info {
            flex: 1;
        }

        .slide-file-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .slide-file-meta {
            font-size: 11px;
            color: var(--neutral-dark);
        }

        .slide-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .slide-thumb {
            aspect-ratio: 16/9;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.15s;
            background: var(--neutral-lighter);
            position: relative;
        }

        .slide-thumb:hover {
            border-color: var(--neutral-dark);
        }

        .slide-thumb.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .slide-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slide-thumb .slide-number {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .slide-thumb .slide-check {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .slide-thumb.selected .slide-check {
            display: flex;
        }

        /* CS Request Tab Styles */
        .cs-header {
            background: linear-gradient(135deg, #0a2351, #1a4380);
            color: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .cs-header h2 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .cs-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .cs-form {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .cs-category {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--neutral-light);
        }

        .cs-category:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .cs-category-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .cs-category-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--neutral-darker);
        }

        .cs-category-info {
            font-size: 12px;
            cursor: help;
        }

        .cs-category-desc {
            font-size: 11px;
            color: var(--neutral-dark);
            margin-bottom: 8px;
        }

        .cs-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .cs-radio,
        .cs-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--neutral-darker);
            cursor: pointer;
            padding: 4px 0;
        }

        .cs-radio input,
        .cs-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .cs-new-badge {
            background: #f5a623;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .cs-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--neutral-light);
        }

        .cs-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--neutral-dark);
            margin-bottom: 4px;
            margin-top: 12px;
        }

        .cs-label:first-child {
            margin-top: 0;
        }

        .cs-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
        }

        .cs-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .cs-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }

        .cs-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Icon Style Grid */
        .icon-style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .icon-style-card {
            border: 2px solid var(--neutral-light);
            border-radius: var(--radius-lg);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--white);
        }

        .icon-style-card:hover {
            border-color: var(--neutral-dark);
        }

        .icon-style-card.selected {
            border-color: var(--primary);
            background: #e7f3ff;
        }

        .icon-style-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon-style-preview {
            width: 50px;
            height: 50px;
            border-radius: var(--radius);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .icon-style-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .icon-style-desc {
            font-size: 11px;
            color: var(--neutral-dark);
        }

        /* Portrait Search Styles */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input-wrapper .search-input {
            padding-right: 80px;
        }

        .search-btn, .clear-btn {
            position: absolute;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            background: var(--primary-dark);
        }

        .clear-btn {
            right: 44px;
            background: var(--neutral-light);
            color: var(--neutral-dark);
        }

        .clear-btn:hover {
            background: var(--neutral);
        }

        .portrait-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .portrait-tag {
            background: var(--surface);
            border: 1px solid var(--neutral-light);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--neutral-darker);
            cursor: pointer;
            transition: all 0.15s;
        }

        .portrait-tag:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .portrait-tag.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .portrait-results-section {
            margin-top: 16px;
        }

        .portrait-loading, .portrait-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--neutral-dark);
        }

        .portrait-empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 12px 0 4px;
            color: var(--neutral-darker);
        }

        .portrait-empty-state p {
            font-size: 13px;
        }

        .portrait-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .portrait-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .portrait-card:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .portrait-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .portrait-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portrait-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 8px 6px 6px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .portrait-card:hover .portrait-card-overlay {
            opacity: 1;
        }

        .portrait-card-name {
            font-size: 11px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .portrait-card-role {
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .portrait-card .selected-check {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .portrait-card.selected .selected-check {
            display: flex;
        }

        .btn-load-more {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: var(--surface);
            border: 1px solid var(--neutral-light);
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            color: var(--neutral-darker);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-load-more:hover {
            background: var(--neutral-light);
        }

        .btn-load-more:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid var(--neutral-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .results-count {
            text-align: center;
            font-size: 12px;
            color: var(--neutral-dark);
            margin-top: 8px;
        }

        .portrait-metadata {
            padding: 12px;
            background: var(--surface);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .portrait-metadata-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--neutral-darker);
        }

        .portrait-metadata-role {
            font-size: 12px;
            color: var(--neutral-dark);
            margin-top: 2px;
        }

        .portrait-metadata-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .portrait-metadata-tag {
            background: var(--neutral-light);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: var(--neutral-dark);
        }
    </style>
</head>
<body>
    <div class="taskpane">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">
                <i class="ms-Icon ms-Icon--ImagePixel"></i>
            </div>
            <div class="header-text">
                <h1>AI Image Generator <span style="font-size: 12px; font-weight: 400; color: var(--neutral-dark);">v1.7</span></h1>
                <p>Powered by OpenAI gpt-image-1</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="images">
                <i class="ms-Icon ms-Icon--Photo2"></i>
                <span>Images</span>
            </button>
            <button class="tab" data-tab="icons">
                <i class="ms-Icon ms-Icon--AppIconDefaultList"></i>
                <span>Icons</span>
            </button>
            <button class="tab" data-tab="portraits">
                <i class="ms-Icon ms-Icon--Contact"></i>
                <span>Portraits</span>
            </button>
            <button class="tab" data-tab="slidewiki">
                <i class="ms-Icon ms-Icon--Library"></i>
                <span>SlideWiki</span>
            </button>
            <button class="tab" data-tab="csrequest">
                <i class="ms-Icon ms-Icon--Ticket"></i>
                <span>CS Request</span>
            </button>
            <button class="tab" data-tab="feedback">
                <i class="ms-Icon ms-Icon--Feedback"></i>
                <span>More</span>
            </button>
        </div>

        <!-- ==================== IMAGES TAB ==================== -->
        <div class="tab-content active" id="tab-images">
            <!-- API Key Section -->
            <div class="api-key-section">
                <div class="api-key-header">
                    <label>OpenAI API Key</label>
                    <span id="apiKeyStatus" class="api-key-status disconnected">Not Set</span>
                </div>
                <div class="api-key-input-wrapper">
                    <input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
                    <button class="btn-save-key" id="btnSaveKey" type="button">Save</button>
                </div>
                <script>
                    // Immediate binding for Save button (runs as soon as button exists)
                    (function() {
                        var btn = document.getElementById('btnSaveKey');
                        var input = document.getElementById('apiKeyInput');
                        var statusEl = document.getElementById('apiKeyStatus');
                        
                        btn.onclick = function() {
                            console.log('Save button clicked');
                            var key = input.value.trim();
                            if (!key || key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                                alert('Please enter your API key first');
                                return;
                            }
                            
                            // Store in window for global access
                            window._openaiApiKey = key;
                            
                            // Also store in state if it exists
                            if (typeof state !== 'undefined') {
                                state.apiKey = key;
                            }
                            
                            // Try localStorage (clear history first to make room)
                            try {
                                localStorage.removeItem('image_history');
                                localStorage.setItem('openai_api_key', key);
                                console.log('Key saved to localStorage');
                            } catch(e) {
                                console.log('localStorage failed, key only in memory');
                            }
                            
                            // Update UI
                            input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                            statusEl.textContent = 'Connected';
                            statusEl.className = 'api-key-status connected';
                            
                            // Enable generate buttons
                            var btns = document.querySelectorAll('.btn-generate');
                            btns.forEach(function(b) { b.disabled = false; });
                            
                            // Update generate buttons if function exists
                            if (typeof updateGenerateButtons === 'function') {
                                updateGenerateButtons();
                            }
                            
                            alert('API key saved!');
                        };
                    })();
                </script>
            </div>

            <!-- Prompt Section -->
            <div class="prompt-section">
                <label for="promptInput">Describe your image</label>
                <textarea 
                    id="promptInput" 
                    class="prompt-textarea" 
                    placeholder="A serene mountain landscape at sunset with golden light reflecting off a calm lake..."
                ></textarea>
                
                <div class="options-row">
                    <div class="option-group">
                        <label>Size</label>
                        <select id="sizeSelect">
                            <option value="auto">Auto (from selection)</option>
                            <option value="1024x1024">Square (1024√ó1024)</option>
                            <option value="1792x1024">Landscape (1792√ó1024)</option>
                            <option value="1024x1792">Portrait (1024√ó1792)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>Quality</label>
                        <select id="qualitySelect">
                            <option value="medium">Medium</option>
                            <option value="low">Low (faster)</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <div id="shapeInfo" class="shape-info">
                    <i class="ms-Icon ms-Icon--RectangleShape"></i>
                    <span id="shapeInfoText">No shape selected - will use size setting</span>
                </div>
                
                <button class="btn-generate" id="btnGenerate" disabled>
                    <i class="ms-Icon ms-Icon--Rocket"></i>
                    <span>Generate Image</span>
                </button>
            </div>

            <!-- Status Message -->
            <div id="statusMessage" class="status-message">
                <i class="ms-Icon"></i>
                <span></span>
            </div>

            <!-- Preview Section -->
            <div id="previewSection" class="preview-section">
                <div class="preview-header">
                    <h2>Generated Image</h2>
                </div>
                
                <div class="preview-image-container">
                    <div id="previewLoading" class="preview-loading">
                        <div class="spinner-large"></div>
                        <p>Generating your image...</p>
                    </div>
                    <img id="previewImage" class="preview-image" alt="Generated image preview">
                </div>
                
                <div class="insert-options">
                    <div class="insert-option selected" data-mode="auto">
                        <i class="ms-Icon ms-Icon--AutoFit"></i>
                        <span>Auto Detect</span>
                    </div>
                    <div class="insert-option" data-mode="slide">
                        <i class="ms-Icon ms-Icon--Presentation"></i>
                        <span>On Slide</span>
                    </div>
                    <div class="insert-option" data-mode="fill">
                        <i class="ms-Icon ms-Icon--RectangleShape"></i>
                        <span>Fill Shape</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-action btn-regenerate" id="btnRegenerate">
                        <i class="ms-Icon ms-Icon--Refresh"></i>
                        Regenerate
                    </button>
                    <button class="btn-action btn-insert" id="btnInsert">
                        <i class="ms-Icon ms-Icon--CheckMark"></i>
                        Insert
                    </button>
                </div>
            </div>

            <!-- History Section -->
            <div class="history-section">
                <div class="history-header">
                    <h3>Recent Images</h3>
                    <button class="btn-clear-history" id="btnClearHistory">Clear</button>
                </div>
                <div id="historyGrid" class="history-grid">
                    <div class="history-empty">No images generated yet</div>
                </div>
            </div>
        </div>

        <!-- ==================== ICONS TAB ==================== -->
        <div class="tab-content" id="tab-icons">
            <!-- Style Selection -->
            <div class="prompt-section">
                <label>Select Style</label>
                <div class="icon-style-grid" id="iconStyleGrid">
                    <div class="icon-style-card selected" data-style="1">
                        <div class="icon-style-preview" style="background: linear-gradient(135deg, #ffe135, #f5c842);">
                            üçå
                        </div>
                        <div class="icon-style-name">Style 1</div>
                        <div class="icon-style-desc">Banana</div>
                    </div>
                    <div class="icon-style-card" data-style="2">
                        <div class="icon-style-preview" style="background: linear-gradient(135deg, #1a237e, #3949ab);">
                            ü¶¢
                        </div>
                        <div class="icon-style-name">Style 2</div>
                        <div class="icon-style-desc">Origami</div>
                    </div>
                    <div class="icon-style-card" data-style="3">
                        <div class="icon-style-preview" style="background: linear-gradient(135deg, #e0e0e0, #9e9e9e);">
                            üîú
                        </div>
                        <div class="icon-style-name">Style 3</div>
                        <div class="icon-style-desc">Coming soon</div>
                    </div>
                    <div class="icon-style-card" data-style="4">
                        <div class="icon-style-preview" style="background: linear-gradient(135deg, #e0e0e0, #9e9e9e);">
                            üîú
                        </div>
                        <div class="icon-style-name">Style 4</div>
                        <div class="icon-style-desc">Coming soon</div>
                    </div>
                </div>
            </div>

            <!-- Subject Input -->
            <div class="prompt-section">
                <label for="iconSubjectInput">Enter Subject</label>
                <input 
                    type="text"
                    id="iconSubjectInput" 
                    class="cs-input"
                    placeholder="play button, house, car, lightbulb..."
                    style="font-size: 14px;"
                >
                <p style="font-size: 11px; color: var(--neutral-dark); margin-top: 6px;">
                    Enter a simple object or symbol. The selected style will be applied automatically.
                </p>

                <div class="options-row" style="margin-top: 12px;">
                    <div class="option-group">
                        <label>Quality</label>
                        <select id="iconQualitySelect">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low (faster)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-generate" id="btnGenerateIcon" disabled>
                    <i class="ms-Icon ms-Icon--Rocket"></i>
                    <span>Generate Icon</span>
                </button>
            </div>

            <!-- Status Message -->
            <div id="iconStatusMessage" class="status-message">
                <i class="ms-Icon"></i>
                <span></span>
            </div>

            <!-- Preview Section -->
            <div id="iconPreviewSection" class="preview-section">
                <div class="preview-header">
                    <h2>Generated Icon</h2>
                </div>
                
                <div class="preview-image-container">
                    <div id="iconPreviewLoading" class="preview-loading">
                        <div class="spinner-large"></div>
                        <p>Generating your icon...</p>
                    </div>
                    <img id="iconPreviewImage" class="preview-image" alt="Generated icon preview">
                </div>
                
                <div class="action-buttons">
                    <button class="btn-action btn-regenerate" id="btnRegenerateIcon">
                        <i class="ms-Icon ms-Icon--Refresh"></i>
                        Regenerate
                    </button>
                    <button class="btn-action btn-insert" id="btnInsertIcon">
                        <i class="ms-Icon ms-Icon--CheckMark"></i>
                        Insert
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== PORTRAITS TAB ==================== -->
        <div class="tab-content" id="tab-portraits">
            <!-- Frontify API Key Section -->
            <div class="api-key-section">
                <div class="api-key-header">
                    <label>Frontify API Key</label>
                    <span class="api-key-status" id="frontifyKeyStatus">Not configured</span>
                </div>
                <div class="api-key-input-row">
                    <input 
                        type="password" 
                        id="frontifyKeyInput" 
                        class="api-key-input" 
                        placeholder="Enter your Frontify API key..."
                    >
                    <button class="btn-save-key" id="btnSaveFrontifyKey" style="background: var(--primary);">Save</button>
                </div>
                <p class="api-key-help">
                    Get your API key from <a href="https://brand.oliverwyman.com/settings/api" target="_blank">Frontify Settings ‚Üí API</a>
                </p>
            </div>

            <!-- Search Section -->
            <div class="prompt-section">
                <label for="portraitSearchInput">Search People</label>
                <div class="search-input-wrapper">
                    <input 
                        type="text"
                        id="portraitSearchInput" 
                        class="cs-input search-input"
                        placeholder="Search by name, role, department..."
                        style="font-size: 14px; padding-right: 80px;"
                        disabled
                    >
                    <button class="search-btn" id="btnSearchPortrait" disabled>
                        <i class="ms-Icon ms-Icon--Search"></i>
                    </button>
                    <button class="clear-btn" id="btnClearPortraitSearch" style="display: none;">
                        <i class="ms-Icon ms-Icon--Cancel"></i>
                    </button>
                </div>
                
                <!-- Quick Tags -->
                <div class="portrait-tags">
                    <button class="portrait-tag" data-tag="business" disabled>Business</button>
                    <button class="portrait-tag" data-tag="casual" disabled>Casual</button>
                    <button class="portrait-tag" data-tag="executive" disabled>Executive</button>
                    <button class="portrait-tag" data-tag="creative" disabled>Creative</button>
                    <button class="portrait-tag" data-tag="diverse" disabled>Diverse</button>
                    <button class="portrait-tag" data-tag="team" disabled>Team</button>
                </div>
            </div>

            <!-- Status Message -->
            <div id="portraitStatusMessage" class="status-message">
                <i class="ms-Icon"></i>
                <span></span>
            </div>

            <!-- Results Section -->
            <div id="portraitResultsSection" class="portrait-results-section">
                <!-- Loading State -->
                <div id="portraitResultsLoading" class="portrait-loading" style="display: none;">
                    <div class="spinner-large"></div>
                    <p>Searching people library...</p>
                </div>

                <!-- Empty State -->
                <div id="portraitEmptyState" class="portrait-empty-state">
                    <i class="ms-Icon ms-Icon--Contact" style="font-size: 48px; color: var(--neutral-light);"></i>
                    <h3>Search for People</h3>
                    <p>Enter a search term or click a tag to find portraits from your library.</p>
                </div>

                <!-- No Results State -->
                <div id="portraitNoResults" class="portrait-empty-state" style="display: none;">
                    <i class="ms-Icon ms-Icon--SearchIssue" style="font-size: 48px; color: var(--neutral-light);"></i>
                    <h3>No Results Found</h3>
                    <p>Try a different search term or browse by tags.</p>
                </div>

                <!-- Results Grid -->
                <div id="portraitResultsGrid" class="portrait-grid"></div>

                <!-- Load More Button -->
                <button class="btn-load-more" id="btnLoadMorePortraits" style="display: none;">
                    <span>Load More</span>
                    <div class="spinner-small" id="loadMoreSpinner" style="display: none;"></div>
                </button>

                <!-- Results Count -->
                <div id="portraitResultsCount" class="results-count" style="display: none;"></div>
            </div>

            <!-- Selected Portrait Preview -->
            <div id="portraitPreviewSection" class="preview-section">
                <div class="preview-header">
                    <h2>Selected Portrait</h2>
                </div>
                
                <div class="preview-image-container">
                    <img id="portraitPreviewImage" class="preview-image" alt="Selected portrait preview">
                </div>

                <div id="portraitMetadata" class="portrait-metadata"></div>
                
                <div class="action-buttons">
                    <button class="btn-action btn-insert" id="btnInsertPortrait">
                        <i class="ms-Icon ms-Icon--CheckMark"></i>
                        Insert
                    </button>
                </div>
            </div>

            <!-- API Connection Info -->
            <div class="feedback-info" style="margin-top: 16px;">
                <h3>üîê Secure API Access</h3>
                <p style="font-size: 12px; color: var(--neutral-dark);">
                    Your API key is stored locally on your device and never shared.<br><br>
                    <strong>Get your API key:</strong><br>
                    1. Go to <a href="https://brand.oliverwyman.com" target="_blank">brand.oliverwyman.com</a><br>
                    2. Navigate to Settings ‚Üí API<br>
                    3. Generate or copy your API token
                </p>
            </div>
        </div>

        <!-- ==================== SLIDEWIKI TAB ==================== -->
        <div class="tab-content" id="tab-slidewiki">
            <!-- SharePoint Connection -->
            <div class="api-key-section">
                <div class="api-key-header">
                    <label>SharePoint Connection</label>
                    <span id="sharepointStatus" class="api-key-status disconnected">Not Connected</span>
                </div>
                <button class="btn-generate" id="btnConnectSharePoint" style="margin-top: 8px;">
                    <i class="ms-Icon ms-Icon--PlugConnected"></i>
                    <span>Connect to Microsoft 365</span>
                </button>
                <div class="api-key-help" style="margin-top: 8px;">
                    Sign in with your Microsoft account to access SharePoint slides.
                </div>
            </div>

            <!-- Folder Path -->
            <div class="prompt-section">
                <label for="sharepointPath">SharePoint Site URL</label>
                <input 
                    type="text" 
                    id="sharepointPath" 
                    class="prompt-textarea" 
                    style="min-height: auto; padding: 10px 12px;"
                    placeholder="https://company.sharepoint.com/sites/..."
                    value="https://mmcglobal.sharepoint.com/sites/SlideWiki"
                >
                <button class="btn-generate" id="btnLoadSlides" style="margin-top: 12px;" disabled>
                    <i class="ms-Icon ms-Icon--FolderOpen"></i>
                    <span>Load Slides</span>
                </button>
            </div>

            <!-- Slides List -->
            <div class="prompt-section" id="slidesListSection" style="display: none;">
                <label>Available Presentations</label>
                <div id="slidesList" class="slides-list">
                    <!-- Slides will be loaded here -->
                </div>
            </div>

            <!-- Slide Preview -->
            <div class="preview-section" id="slidePreviewSection">
                <div class="preview-header">
                    <h2>Slide Preview</h2>
                </div>
                <div id="slidePreviewLoading" class="preview-loading" style="display: none;">
                    <div class="spinner-large"></div>
                    <p>Loading slides...</p>
                </div>
                <div id="slidePreviewGrid" class="slide-preview-grid">
                    <!-- Slide thumbnails will appear here -->
                    <div class="history-empty">
                        Connect to SharePoint and load a presentation to see slides here.
                    </div>
                </div>
            </div>

            <!-- Insert Button -->
            <div class="action-buttons" id="slideActions" style="display: none;">
                <button class="btn-action btn-insert" id="btnInsertSlide">
                    <i class="ms-Icon ms-Icon--AddTo"></i>
                    <span>Insert Selected Slides</span>
                </button>
            </div>

            <!-- Status Message -->
            <div id="slidewikiStatusMessage" class="status-message"></div>

            <!-- Demo Mode Notice -->
            <div class="feedback-section" style="margin-top: 16px; background: #fff4ce;">
                <h2 style="color: #8a6914;">üöß Demo Mode</h2>
                <p style="font-size: 13px; color: #8a6914;">
                    This is a demo showing how SlideWiki will work. To enable real SharePoint access, we need to set up Microsoft Graph API.<br><br>
                    <strong>Your SharePoint site:</strong><br>
                    <code style="font-size: 11px; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;">mmcglobal.sharepoint.com/sites/SlideWiki</code><br><br>
                    <strong>To enable:</strong><br>
                    1. Register an Azure AD app<br>
                    2. Grant Files.Read.All permission<br>
                    3. Share the Client ID with me<br><br>
                    <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" style="color: #8a6914;">‚Üí Open Azure Portal</a>
                </p>
            </div>
        </div>

        <!-- ==================== CS REQUEST TAB ==================== -->
        <div class="tab-content" id="tab-csrequest">
            <!-- Header -->
            <div class="cs-header">
                <h2>Creative Studio Request</h2>
                <p>Submit your request and we'll get back to you quickly.</p>
            </div>

            <!-- Request Form -->
            <div class="cs-form">
                <!-- Presentation Section -->
                <div class="cs-category">
                    <div class="cs-category-header">
                        <span class="cs-category-title">Presentation</span>
                        <span class="cs-category-info" title="Anything presentation-related">‚ÑπÔ∏è</span>
                    </div>
                    <p class="cs-category-desc">Anything presentation-related</p>
                    <div class="cs-options">
                        <label class="cs-radio"><input type="radio" name="presentation" value="quickfix"> Quick fix</label>
                        <label class="cs-radio"><input type="radio" name="presentation" value="refine"> Refine</label>
                        <label class="cs-radio"><input type="radio" name="presentation" value="redesign"> Redesign</label>
                        <label class="cs-radio"><input type="radio" name="presentation" value="bespoke"> Bespoke</label>
                        <label class="cs-radio"><input type="radio" name="presentation" value="template"> Template</label>
                    </div>
                </div>

                <!-- Design Section -->
                <div class="cs-category">
                    <div class="cs-category-header">
                        <span class="cs-category-title">Design</span>
                        <span class="cs-category-info" title="Any non-presentation design">‚ÑπÔ∏è</span>
                    </div>
                    <p class="cs-category-desc">Any non-presentation design</p>
                    <div class="cs-options">
                        <label class="cs-checkbox"><input type="checkbox" name="design" value="publications"> Publications & reports</label>
                        <label class="cs-checkbox"><input type="checkbox" name="design" value="social"> Social media</label>
                        <label class="cs-checkbox"><input type="checkbox" name="design" value="flyers"> Flyers/Ads</label>
                        <label class="cs-checkbox"><input type="checkbox" name="design" value="events"> Events assets</label>
                        <label class="cs-checkbox"><input type="checkbox" name="design" value="other"> Other</label>
                    </div>
                </div>

                <!-- Web Section -->
                <div class="cs-category">
                    <div class="cs-category-header">
                        <span class="cs-category-title">Web</span>
                        <span class="cs-category-info" title="Anything digital">‚ÑπÔ∏è</span>
                    </div>
                    <p class="cs-category-desc">Anything digital</p>
                    <div class="cs-options">
                        <label class="cs-checkbox"><input type="checkbox" name="web" value="assets"> Web assets (e.g. exhibits)</label>
                        <label class="cs-checkbox"><input type="checkbox" name="web" value="magazine"> Digital magazine</label>
                        <label class="cs-checkbox"><input type="checkbox" name="web" value="microsite"> Microsite</label>
                        <label class="cs-checkbox"><input type="checkbox" name="web" value="uxui"> UX/UI</label>
                        <label class="cs-checkbox"><input type="checkbox" name="web" value="other"> Other</label>
                    </div>
                </div>

                <!-- Video/Photo Section -->
                <div class="cs-category">
                    <div class="cs-category-header">
                        <span class="cs-category-title">Video/Photo</span>
                        <span class="cs-category-info" title="Any video, photo or animation">‚ÑπÔ∏è</span>
                    </div>
                    <p class="cs-category-desc">Any video, photo or animation</p>
                    <div class="cs-options">
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="production"> Video production</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="filming"> Video filming</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="profile"> Profile photo</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="event"> Event shooting</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="animation"> Animation</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="podcast"> Podcast</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="script"> Script development</label>
                        <label class="cs-checkbox"><input type="checkbox" name="video" value="other"> Other</label>
                    </div>
                </div>

                <!-- Brand Section -->
                <div class="cs-category">
                    <div class="cs-category-header">
                        <span class="cs-category-title">Brand</span>
                        <span class="cs-category-info" title="Any brand-related project">‚ÑπÔ∏è</span>
                    </div>
                    <p class="cs-category-desc">Any brand-related project</p>
                    <div class="cs-options">
                        <label class="cs-radio"><input type="radio" name="brand" value="logos"> Logos</label>
                        <label class="cs-radio"><input type="radio" name="brand" value="subbranding"> Sub-branding</label>
                        <label class="cs-radio"><input type="radio" name="brand" value="merchandise"> Merchandise 2026 <span class="cs-new-badge">New</span></label>
                        <label class="cs-radio"><input type="radio" name="brand" value="other"> Other</label>
                    </div>
                </div>

                <!-- Project Details -->
                <div class="cs-details">
                    <label class="cs-label">Project Title</label>
                    <input type="text" id="csProjectTitle" class="cs-input" placeholder="Brief title for your request">
                    
                    <label class="cs-label">Description</label>
                    <textarea id="csDescription" class="cs-textarea" placeholder="Describe your project, timeline, and any specific requirements..."></textarea>
                    
                    <label class="cs-label">Deadline</label>
                    <input type="date" id="csDeadline" class="cs-input">
                </div>

                <!-- Submit Button -->
                <button class="btn-generate" id="btnSubmitCSRequest" style="margin-top: 16px;">
                    <i class="ms-Icon ms-Icon--Send"></i>
                    <span>Submit Request</span>
                </button>

                <!-- Status Message -->
                <div id="csStatusMessage" class="status-message"></div>
            </div>

            <!-- Link to Full Portal -->
            <div class="feedback-info" style="margin-top: 16px;">
                <h3>Need the full portal?</h3>
                <p style="font-size: 13px; color: var(--neutral-dark);">
                    For more options and to track your requests, visit the full Creative Studio Portal:<br><br>
                    <a href="https://mmcglobal.sharepoint.com/sites/CreativeStudio" target="_blank">‚Üí Open Creative Studio Portal</a>
                </p>
            </div>
        </div>

        <!-- ==================== FEEDBACK TAB ==================== -->
        <div class="tab-content" id="tab-feedback">
            <div class="feedback-section">
                <h2>Send Feedback</h2>
                <p>Help us improve this add-in! Share your thoughts, report bugs, or request features.</p>
                
                <textarea 
                    id="feedbackText" 
                    class="feedback-textarea" 
                    placeholder="Your feedback..."
                ></textarea>
                
                <div class="option-group" style="margin-bottom: 12px;">
                    <label>Feedback Type</label>
                    <select id="feedbackType">
                        <option value="suggestion">üí° Suggestion</option>
                        <option value="bug">üêõ Bug Report</option>
                        <option value="feature">‚ú® Feature Request</option>
                        <option value="other">üí¨ Other</option>
                    </select>
                </div>
                
                <button class="btn-submit-feedback" id="btnSubmitFeedback">
                    <i class="ms-Icon ms-Icon--Send"></i>
                    Send Feedback
                </button>
            </div>

            <div class="feedback-info">
                <h3>Contact</h3>
                <p style="font-size: 13px; color: var(--neutral-dark);">
                    üìß Email: <a href="/cdn-cgi/l/email-protection#4b2d2e2e2f292a28200b2e332a263b272e65282426"><span class="__cf_email__" data-cfemail="b3d5d6d6d7d1d2d0d8f3d6cbd2dec3dfd69dd0dcde">[email&#160;protected]</span></a><br>
                    üêô GitHub: <a href="https://github.com/jens-lischka/DTP_PPT" target="_blank">Report an issue</a>
                </p>
            </div>

            <div class="feedback-section" style="margin-top: 16px;">
                <h2>About</h2>
                <p style="font-size: 13px; color: var(--neutral-dark);">
                    <strong>AI Image Generator</strong> v1.7<br><br>
                    Generate AI images, icons, and portraits using OpenAI's gpt-image-1 and insert them directly into your PowerPoint slides.<br><br>
                    Made with ‚ù§Ô∏è
                </p>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ======================
        // State Management
        // ======================
        const state = {
            apiKey: '',
            currentImageUrl: null,
            currentImageBase64: null,
            currentImageSize: '1024x1024',
            insertMode: 'auto',
            history: [],
            isGenerating: false,
            selectedShape: null,
            activeTab: 'images',
            // Icon tab state
            iconStyleNumber: 1,
            iconImageBase64: null,
            // Portrait tab state (People Library Search)
            frontifyApiKey: localStorage.getItem('frontify_api_key') || '',
            portraitSearchQuery: '',
            portraitSearchResults: [],
            portraitCurrentPage: 1,
            portraitHasMore: false,
            portraitIsLoading: false,
            portraitIsLoadingMore: false,
            portraitHasSearched: false,
            portraitTotalResults: 0,
            selectedPortrait: null,
            portraitImageBase64: null,
            // SlideWiki state
            sharepointConnected: false,
            sharepointFiles: [],
            selectedSlides: [],
            currentPresentation: null
        };

        // ======================
        // DOM Elements
        // ======================
        const elements = {
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Images tab
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            btnSaveKey: document.getElementById('btnSaveKey'),
            promptInput: document.getElementById('promptInput'),
            sizeSelect: document.getElementById('sizeSelect'),
            qualitySelect: document.getElementById('qualitySelect'),
            btnGenerate: document.getElementById('btnGenerate'),
            statusMessage: document.getElementById('statusMessage'),
            previewSection: document.getElementById('previewSection'),
            previewLoading: document.getElementById('previewLoading'),
            previewImage: document.getElementById('previewImage'),
            btnRegenerate: document.getElementById('btnRegenerate'),
            btnInsert: document.getElementById('btnInsert'),
            historyGrid: document.getElementById('historyGrid'),
            btnClearHistory: document.getElementById('btnClearHistory'),
            insertOptions: document.querySelectorAll('.insert-option'),
            shapeInfo: document.getElementById('shapeInfo'),
            shapeInfoText: document.getElementById('shapeInfoText'),
            
            // Icons tab
            iconSubjectInput: document.getElementById('iconSubjectInput'),
            iconStyleGrid: document.querySelectorAll('#iconStyleGrid .icon-style-card'),
            iconQualitySelect: document.getElementById('iconQualitySelect'),
            btnGenerateIcon: document.getElementById('btnGenerateIcon'),
            iconStatusMessage: document.getElementById('iconStatusMessage'),
            iconPreviewSection: document.getElementById('iconPreviewSection'),
            iconPreviewLoading: document.getElementById('iconPreviewLoading'),
            iconPreviewImage: document.getElementById('iconPreviewImage'),
            btnRegenerateIcon: document.getElementById('btnRegenerateIcon'),
            btnInsertIcon: document.getElementById('btnInsertIcon'),
            
            // Portraits tab - Frontify API
            frontifyKeyInput: document.getElementById('frontifyKeyInput'),
            btnSaveFrontifyKey: document.getElementById('btnSaveFrontifyKey'),
            frontifyKeyStatus: document.getElementById('frontifyKeyStatus'),
            // Portraits tab - Search
            portraitSearchInput: document.getElementById('portraitSearchInput'),
            btnSearchPortrait: document.getElementById('btnSearchPortrait'),
            btnClearPortraitSearch: document.getElementById('btnClearPortraitSearch'),
            portraitTags: document.querySelectorAll('.portrait-tag'),
            portraitResultsSection: document.getElementById('portraitResultsSection'),
            portraitResultsLoading: document.getElementById('portraitResultsLoading'),
            portraitEmptyState: document.getElementById('portraitEmptyState'),
            portraitNoResults: document.getElementById('portraitNoResults'),
            portraitResultsGrid: document.getElementById('portraitResultsGrid'),
            btnLoadMorePortraits: document.getElementById('btnLoadMorePortraits'),
            loadMoreSpinner: document.getElementById('loadMoreSpinner'),
            portraitResultsCount: document.getElementById('portraitResultsCount'),
            portraitMetadata: document.getElementById('portraitMetadata'),
            portraitStatusMessage: document.getElementById('portraitStatusMessage'),
            portraitPreviewSection: document.getElementById('portraitPreviewSection'),
            portraitPreviewImage: document.getElementById('portraitPreviewImage'),
            btnInsertPortrait: document.getElementById('btnInsertPortrait'),
            
            // SlideWiki tab
            sharepointStatus: document.getElementById('sharepointStatus'),
            btnConnectSharePoint: document.getElementById('btnConnectSharePoint'),
            sharepointPath: document.getElementById('sharepointPath'),
            btnLoadSlides: document.getElementById('btnLoadSlides'),
            slidesListSection: document.getElementById('slidesListSection'),
            slidesList: document.getElementById('slidesList'),
            slidePreviewSection: document.getElementById('slidePreviewSection'),
            slidePreviewLoading: document.getElementById('slidePreviewLoading'),
            slidePreviewGrid: document.getElementById('slidePreviewGrid'),
            slideActions: document.getElementById('slideActions'),
            btnInsertSlide: document.getElementById('btnInsertSlide'),
            slidewikiStatusMessage: document.getElementById('slidewikiStatusMessage'),
            
            // CS Request tab
            csProjectTitle: document.getElementById('csProjectTitle'),
            csDescription: document.getElementById('csDescription'),
            csDeadline: document.getElementById('csDeadline'),
            btnSubmitCSRequest: document.getElementById('btnSubmitCSRequest'),
            csStatusMessage: document.getElementById('csStatusMessage'),
            
            // Feedback tab
            feedbackText: document.getElementById('feedbackText'),
            feedbackType: document.getElementById('feedbackType'),
            btnSubmitFeedback: document.getElementById('btnSubmitFeedback')
        };

        // ======================
        // Office.js Initialization
        // ======================
        Office.onReady((info) => {
            console.log('Office ready:', info.host);
            initializeApp();
        });

        // Also initialize after DOM is ready (fallback)
        document.addEventListener('DOMContentLoaded', () => {
            // Give Office.js a moment, then init anyway
            setTimeout(() => {
                if (!state.apiKey && !elements.btnSaveKey._listenerAdded) {
                    console.log('Fallback initialization');
                    initializeApp();
                }
            }, 1000);
        });

        function initializeApp() {
            // Prevent double initialization
            if (elements.btnSaveKey._listenerAdded) return;
            elements.btnSaveKey._listenerAdded = true;
            
            // Clear oversized data from localStorage
            try {
                const historySize = (localStorage.getItem('image_history') || '').length;
                if (historySize > 50000) { // If history > 50KB, clear it
                    localStorage.removeItem('image_history');
                    console.log('Cleared oversized history');
                }
            } catch (e) {
                try { localStorage.clear(); } catch(e2) {}
            }

            // Load saved API key
            try {
                const savedKey = localStorage.getItem('openai_api_key');
                if (savedKey) {
                    state.apiKey = savedKey;
                    elements.apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    updateApiKeyStatus(true);
                }
            } catch (e) {
                console.warn('Could not load API key from storage');
            }

            // Load history
            try {
                const savedHistory = localStorage.getItem('image_history');
                if (savedHistory) {
                    state.history = JSON.parse(savedHistory);
                    renderHistory();
                }
            } catch (e) {
                state.history = [];
            }

            setupEventListeners();
            updateGenerateButtons();
        }

        function setupEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // API Key
            elements.btnSaveKey.addEventListener('click', saveApiKey);
            elements.apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveApiKey();
            });

            // Images tab
            elements.btnGenerate.addEventListener('click', () => generateImage('images'));
            elements.promptInput.addEventListener('input', updateGenerateButtons);
            elements.btnRegenerate.addEventListener('click', () => generateImage('images'));
            elements.btnInsert.addEventListener('click', () => insertImage('images'));
            elements.insertOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.insertOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.insertMode = option.dataset.mode;
                });
            });
            elements.btnClearHistory.addEventListener('click', clearHistory);

            // Icons tab
            elements.btnGenerateIcon.addEventListener('click', () => generateImage('icons'));
            elements.iconSubjectInput.addEventListener('input', updateGenerateButtons);
            elements.btnRegenerateIcon.addEventListener('click', () => generateImage('icons'));
            elements.btnInsertIcon.addEventListener('click', () => insertImage('icons'));
            elements.iconStyleGrid.forEach(card => {
                card.addEventListener('click', () => {
                    const styleNum = parseInt(card.dataset.style);
                    // Only allow Style 1 and 2 for now
                    if (styleNum > 2) {
                        alert('This style is coming soon! Please use Style 1 or 2 for now.');
                        return;
                    }
                    elements.iconStyleGrid.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    state.iconStyleNumber = styleNum;
                });
            });

            // Portraits tab - Frontify API Key
            elements.btnSaveFrontifyKey.addEventListener('click', saveFrontifyApiKey);
            elements.frontifyKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveFrontifyApiKey();
            });
            // Initialize Frontify key status
            initializeFrontifyKey();

            // Portraits tab (People Library Search)
            elements.btnSearchPortrait.addEventListener('click', () => searchPortraits());
            elements.portraitSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchPortraits();
            });
            elements.btnClearPortraitSearch.addEventListener('click', clearPortraitSearch);
            elements.btnInsertPortrait.addEventListener('click', () => insertPortrait());
            elements.btnLoadMorePortraits.addEventListener('click', loadMorePortraits);
            elements.portraitTags.forEach(tag => {
                tag.addEventListener('click', () => {
                    if (!state.frontifyApiKey && !window._frontifyApiKey) {
                        showPortraitStatus('Please configure your Frontify API key first', 'error');
                        return;
                    }
                    elements.portraitTags.forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    elements.portraitSearchInput.value = tag.dataset.tag;
                    searchPortraits(tag.dataset.tag);
                });
            });

            // SlideWiki tab
            elements.btnConnectSharePoint.addEventListener('click', connectToSharePoint);
            elements.sharepointPath.addEventListener('input', () => {
                elements.btnLoadSlides.disabled = !elements.sharepointPath.value.trim() || !state.sharepointConnected;
            });
            elements.btnLoadSlides.addEventListener('click', loadSharePointSlides);
            elements.btnInsertSlide.addEventListener('click', insertSelectedSlides);

            // CS Request tab
            elements.btnSubmitCSRequest.addEventListener('click', submitCSRequest);

            // Feedback tab
            elements.btnSubmitFeedback.addEventListener('click', submitFeedback);

            // Shape detection
            detectSelectedShape();
            setInterval(detectSelectedShape, 1000);
        }

        // ======================
        // Tab Switching
        // ======================
        function switchTab(tabName) {
            state.activeTab = tabName;
            
            elements.tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            elements.tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
        }

        // ======================
        // API Key Management
        // ======================
        function saveApiKey() {
            const key = elements.apiKeyInput.value.trim();
            if (key && key !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                // Always set in memory first - this makes the add-in work
                state.apiKey = key;
                elements.apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateApiKeyStatus(true);
                
                // Try to persist to localStorage (optional, may fail)
                try {
                    // Clear everything first to make room
                    localStorage.removeItem('image_history');
                    state.history = [];
                    renderHistory();
                    localStorage.setItem('openai_api_key', key);
                    showStatus('API key saved!', 'success', 'images');
                } catch (e) {
                    console.warn('Could not persist API key to localStorage:', e);
                    // Still works for this session
                    showStatus('API key set for this session', 'info', 'images');
                }
            }
            updateGenerateButtons();
        }

        function updateApiKeyStatus(isSet) {
            if (isSet) {
                elements.apiKeyStatus.textContent = 'Connected';
                elements.apiKeyStatus.className = 'api-key-status connected';
            } else {
                elements.apiKeyStatus.textContent = 'Not Set';
                elements.apiKeyStatus.className = 'api-key-status disconnected';
            }
        }

        // ======================
        // Shape Detection
        // ======================
        async function detectSelectedShape() {
            try {
                await PowerPoint.run(async (context) => {
                    const shapes = context.presentation.getSelectedShapes();
                    shapes.load('items');
                    await context.sync();

                    if (shapes.items.length > 0) {
                        const shape = shapes.items[0];
                        shape.load(['width', 'height', 'name', 'type']);
                        await context.sync();

                        state.selectedShape = {
                            width: shape.width,
                            height: shape.height,
                            aspectRatio: shape.width / shape.height,
                            name: shape.name
                        };

                        const dalleSize = getBestDalleSize(state.selectedShape.aspectRatio);
                        elements.shapeInfo.classList.add('detected');
                        elements.shapeInfoText.textContent = `${shape.name} (${Math.round(shape.width)}√ó${Math.round(shape.height)}pt) ‚Üí ${dalleSize}`;
                    } else {
                        state.selectedShape = null;
                        elements.shapeInfo.classList.remove('detected');
                        elements.shapeInfoText.textContent = 'No shape selected - will use size setting';
                    }
                });
            } catch (error) {
                state.selectedShape = null;
            }
        }

        function getBestDalleSize(aspectRatio) {
            if (aspectRatio > 1.35) return '1792x1024';
            if (aspectRatio < 0.75) return '1024x1792';
            return '1024x1024';
        }

        function getGenerationSize() {
            const selectedSize = elements.sizeSelect.value;
            if (selectedSize === 'auto') {
                return state.selectedShape ? getBestDalleSize(state.selectedShape.aspectRatio) : '1024x1024';
            }
            return selectedSize;
        }

        // ======================
        // Image Generation
        // ======================
        async function generateImage(tab) {
            let prompt, quality, statusEl, previewSection, previewLoading, previewImage;
            
            if (tab === 'images') {
                prompt = elements.promptInput.value.trim();
                quality = elements.qualitySelect.value;
                statusEl = elements.statusMessage;
                previewSection = elements.previewSection;
                previewLoading = elements.previewLoading;
                previewImage = elements.previewImage;
            } else if (tab === 'icons') {
                const subject = elements.iconSubjectInput.value.trim();
                const styleNum = state.iconStyleNumber;
                
                // Build prompt based on style
                if (styleNum === 1) {
                    // Style 1: Banana style - use JSON prompt
                    const jsonPrompt = {
                        "object": subject,
                        "task_type": "generation",
                        "priority": {
                            "primary": "create a banana-themed rendition of the object",
                            "secondary": "merge banana characteristics with the object's functional design"
                        },
                        "parameters": {
                            "banana_integration": {
                                "style": "organic and seamless",
                                "features": ["curved banana form", "peel textures", "yellow coloration", "subtle spotting"]
                            },
                            "object_design": {
                                "reference_object_key": "object",
                                "maintain_functionality": true
                            }
                        },
                        "subject": {
                            "main": "banana-inspired version of the object",
                            "attributes": {
                                "physical": "smooth yellow banana texture shaped to match the object's silhouette",
                                "pose": "studio product angle",
                                "expression": "none"
                            }
                        },
                        "environment": {
                            "setting": "clean product studio backdrop",
                            "lighting": {
                                "type": "soft",
                                "direction": "front",
                                "quality": "diffused"
                            }
                        },
                        "style": {
                            "artistic": "photorealistic",
                            "camera": {
                                "angle": "eye_level",
                                "lens": "normal",
                                "aperture": "shallow_depth_of_field"
                            },
                            "mood": "modern and playful",
                            "color_palette": "banana yellow with natural peel browns"
                        },
                        "technical": {
                            "resolution": "high",
                            "aspect_ratio": "1:1",
                            "quality": "maximum"
                        },
                        "constraints": {
                            "avoid": ["cartoon exaggeration", "melting form", "unrecognizable silhouette"],
                            "ensure": ["clear banana identity", "clear object identity"]
                        },
                        "output_specs": {
                            "include_synthid": true,
                            "file_type": "high_resolution_image",
                            "transparent_background": true
                        }
                    };
                    prompt = "Create an image:\n" + JSON.stringify(jsonPrompt, null, 2);
                } else if (styleNum === 2) {
                    // Style 2: Origami style - midnight blue paper
                    const jsonPrompt = {
                        "object": subject,
                        "task_type": "generation",
                        "priority": {
                            "primary": "create an origami-style rendition of the object",
                            "secondary": "merge origami characteristics with the object's functional design"
                        },
                        "parameters": {
                            "origami_integration": {
                                "style": "organic and seamless",
                                "features": ["precise fold geometry", "paper creases", "midnight blue paper grain", "clean edges"]
                            },
                            "object_design": {
                                "reference_object_key": "object",
                                "maintain_functionality": true
                            }
                        },
                        "subject": {
                            "main": "origami-inspired version of the object",
                            "attributes": {
                                "physical": "folded midnight blue paper with visible creases, slight paper grain, shaped to match the object's silhouette",
                                "pose": "studio product angle",
                                "expression": "none"
                            }
                        },
                        "environment": {
                            "setting": "clean product studio backdrop",
                            "lighting": {
                                "type": "soft",
                                "direction": "front",
                                "quality": "diffused"
                            }
                        },
                        "style": {
                            "artistic": "photorealistic",
                            "camera": {
                                "angle": "eye_level",
                                "lens": "normal",
                                "aperture": "shallow_depth_of_field"
                            },
                            "mood": "modern and playful",
                            "color_palette": "midnight blue with natural fold shadows and subtle highlights"
                        },
                        "technical": {
                            "resolution": "high",
                            "aspect_ratio": "1:1",
                            "quality": "maximum"
                        },
                        "constraints": {
                            "avoid": ["cartoon exaggeration", "melting form", "unrecognizable silhouette"],
                            "ensure": ["clear origami identity", "clear object identity"]
                        },
                        "output_specs": {
                            "include_synthid": true,
                            "file_type": "high_resolution_image",
                            "transparent_background": true
                        }
                    };
                    prompt = "Create an image:\n" + JSON.stringify(jsonPrompt, null, 2);
                } else {
                    // Placeholder for other styles
                    prompt = `Icon of ${subject}, clean simple design, centered, high quality`;
                }
                
                quality = elements.iconQualitySelect.value;
                statusEl = elements.iconStatusMessage;
                previewSection = elements.iconPreviewSection;
                previewLoading = elements.iconPreviewLoading;
                previewImage = elements.iconPreviewImage;
            }
            // Note: Portraits tab now uses search-based approach, not AI generation

            // Get API key from state or global fallback
            const apiKey = state.apiKey || window._openaiApiKey;
            if (!prompt || !apiKey || state.isGenerating) return;

            state.isGenerating = true;
            updateGenerateButtons();
            
            previewSection.classList.add('visible');
            previewLoading.style.display = 'flex';
            previewImage.style.display = 'none';
            
            const size = tab === 'images' ? getGenerationSize() : '1024x1024';
            showStatus(`Generating ${size} image...`, 'info', tab);

            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-image-1',
                        prompt: prompt,
                        n: 1,
                        size: size,
                        quality: quality
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Failed to generate image');
                }

                const data = await response.json();
                const base64Data = data.data[0].b64_json;
                const imageUrl = `data:image/png;base64,${base64Data}`;

                // Store in appropriate state
                if (tab === 'images') {
                    state.currentImageUrl = imageUrl;
                    state.currentImageBase64 = base64Data;
                    state.currentImageSize = size;
                    addToHistory(imageUrl, elements.promptInput.value.trim(), size);
                } else if (tab === 'icons') {
                    state.iconImageBase64 = base64Data;
                } else if (tab === 'portraits') {
                    state.portraitImageBase64 = base64Data;
                }

                previewImage.src = imageUrl;
                previewImage.style.display = 'block';
                previewLoading.style.display = 'none';

                showStatus('Image generated successfully!', 'success', tab);
            } catch (error) {
                console.error('Generation error:', error);
                showStatus(error.message || 'Failed to generate image', 'error', tab);
                previewLoading.style.display = 'none';
            } finally {
                state.isGenerating = false;
                updateGenerateButtons();
            }
        }

        // ======================
        // Insert Image
        // ======================
        async function insertImage(tab) {
            let base64Data;
            
            if (tab === 'images') {
                base64Data = state.currentImageBase64;
            } else if (tab === 'icons') {
                base64Data = state.iconImageBase64;
            }
            // Note: Portraits use separate insertPortrait() function

            if (!base64Data) {
                showStatus('No image to insert', 'error', tab);
                return;
            }

            showStatus('Inserting image...', 'info', tab);

            // For icons and portraits, always insert at fixed size
            const imgWidth = tab === 'images' && state.selectedShape ? state.selectedShape.width : 300;
            const imgHeight = tab === 'images' && state.selectedShape ? state.selectedShape.height : 300;

            Office.context.document.setSelectedDataAsync(
                base64Data,
                {
                    coercionType: Office.CoercionType.Image,
                    imageWidth: imgWidth,
                    imageHeight: imgHeight
                },
                function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        showStatus('Image inserted!', 'success', tab);
                    } else {
                        showStatus('Failed to insert: ' + result.error.message, 'error', tab);
                    }
                }
            );
        }

        // ======================
        // History Management (completely optional, errors won't break anything)
        // ======================
        function addToHistory(imageUrl, prompt, size = '1024x1024') {
            try {
                // Create a small thumbnail to save storage space
                createThumbnail(imageUrl, 80, (thumbnailUrl) => {
                    state.history.unshift({ 
                        url: thumbnailUrl,
                        fullUrl: imageUrl,
                        prompt: prompt, 
                        size: size, 
                        timestamp: Date.now() 
                    });
                    
                    // Keep only 4 items
                    if (state.history.length > 4) {
                        state.history = state.history.slice(0, 4);
                    }
                    
                    // Try to save (silently fail if quota exceeded)
                    try {
                        const historyToSave = state.history.map(item => ({
                            url: item.url,
                            prompt: item.prompt,
                            size: item.size
                        }));
                        localStorage.setItem('image_history', JSON.stringify(historyToSave));
                    } catch (e) {
                        // Silently ignore storage errors
                    }
                    renderHistory();
                });
            } catch (e) {
                // Silently ignore any errors in history
            }
        }

        // Create a small thumbnail from a base64 image
        function createThumbnail(dataUrl, maxSize, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate thumbnail size
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxSize) {
                        height = height * (maxSize / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = width * (maxSize / height);
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Use JPEG for smaller file size
                callback(canvas.toDataURL('image/jpeg', 0.6));
            };
            img.onerror = function() {
                callback(dataUrl); // Fallback to original
            };
            img.src = dataUrl;
        }

        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyGrid.innerHTML = '<div class="history-empty">No images generated yet</div>';
                return;
            }
            elements.historyGrid.innerHTML = state.history.map((item, index) => `
                <div class="history-item" data-index="${index}" title="${item.prompt}">
                    <img src="${item.url}" alt="Generated image">
                </div>
            `).join('');
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => loadFromHistory(parseInt(item.dataset.index)));
            });
        }

        function loadFromHistory(index) {
            const item = state.history[index];
            if (item) {
                // If we have the full URL in memory, use it; otherwise use the thumbnail
                const imageUrl = item.fullUrl || item.url;
                state.currentImageUrl = imageUrl;
                state.currentImageBase64 = imageUrl.split(',')[1];
                state.currentImageSize = item.size || '1024x1024';
                elements.previewImage.src = imageUrl;
                elements.previewImage.style.display = 'block';
                elements.previewLoading.style.display = 'none';
                elements.previewSection.classList.add('visible');
                elements.promptInput.value = item.prompt;
                showStatus('Image loaded from history', 'info', 'images');
            }
        }

        function clearHistory() {
            state.history = [];
            localStorage.removeItem('image_history');
            renderHistory();
            showStatus('History cleared', 'info', 'images');
        }

        // ======================
        // Portrait/People Search Functions (Frontify API)
        // ======================
        
        // Frontify API Configuration
        const FRONTIFY_CONFIG = {
            API_ENDPOINT: 'https://brand.oliverwyman.com/graphql'
            // API key is provided by user and stored in state.frontifyApiKey
        };

        // Global fallback for Frontify API key (similar to OpenAI)
        window._frontifyApiKey = localStorage.getItem('frontify_api_key') || '';

        // Initialize Frontify API key from localStorage
        function initializeFrontifyKey() {
            try {
                const savedKey = localStorage.getItem('frontify_api_key');
                if (savedKey) {
                    state.frontifyApiKey = savedKey;
                    window._frontifyApiKey = savedKey;
                    elements.frontifyKeyInput.value = savedKey;
                    elements.frontifyKeyStatus.textContent = 'Connected';
                    elements.frontifyKeyStatus.className = 'api-key-status connected';
                    enablePortraitSearch(true);
                } else {
                    enablePortraitSearch(false);
                }
            } catch (e) {
                console.error('Error loading Frontify API key:', e);
                enablePortraitSearch(false);
            }
        }

        // Save Frontify API key
        function saveFrontifyApiKey() {
            const key = elements.frontifyKeyInput.value.trim();
            
            if (!key) {
                showPortraitStatus('Please enter an API key', 'error');
                return;
            }

            // Store in multiple places for reliability
            state.frontifyApiKey = key;
            window._frontifyApiKey = key;

            try {
                localStorage.setItem('frontify_api_key', key);
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }

            elements.frontifyKeyStatus.textContent = 'Connected';
            elements.frontifyKeyStatus.className = 'api-key-status connected';
            enablePortraitSearch(true);
            
            showPortraitStatus('API key saved! You can now search the People library.', 'success');
        }

        // Enable/disable portrait search based on API key
        function enablePortraitSearch(enabled) {
            elements.portraitSearchInput.disabled = !enabled;
            elements.btnSearchPortrait.disabled = !enabled;
            elements.portraitTags.forEach(tag => {
                tag.disabled = !enabled;
                tag.style.opacity = enabled ? '1' : '0.5';
                tag.style.cursor = enabled ? 'pointer' : 'not-allowed';
            });

            if (!enabled) {
                elements.portraitEmptyState.innerHTML = `
                    <i class="ms-Icon ms-Icon--Permissions" style="font-size: 48px; color: var(--neutral-light);"></i>
                    <h3>API Key Required</h3>
                    <p>Enter your Frontify API key above to search the People library.</p>
                `;
            } else {
                elements.portraitEmptyState.innerHTML = `
                    <i class="ms-Icon ms-Icon--Contact" style="font-size: 48px; color: var(--neutral-light);"></i>
                    <h3>Search for People</h3>
                    <p>Enter a search term or click a tag to find portraits from your library.</p>
                `;
            }
        }

        // Library IDs
        const LIBRARY_IDS = {
            ICONS: 'eyJpZGVudGlmaWVyIjo2NTMsInR5cGUiOiJwcm9qZWN0In0=',
            LOGOS: 'eyJpZGVudGlmaWVyIjo1NzEyLCJ0eXBlIjoicHJvamVjdCJ9',
            PEOPLE: 'eyJpZGVudGlmaWVyIjoxMTYsInR5cGUiOiJwcm9qZWN0In0=',
            IMAGERY: 'eyJpZGVudGlmaWVyIjoyMiwidHlwZSI6InByb2plY3QifQ==',
            SLIDES: 'eyJpZGVudGlmaWVyIjo1NzExLCJ0eXBlIjoicHJvamVjdCJ9'
        };

        // GraphQL query for searching assets
        const SEARCH_ASSETS_QUERY = `
            query SearchAssets($projectId: ID!, $query: String, $page: Int, $limit: Int) {
                library(id: $projectId) {
                    assets(query: $query, page: $page, limit: $limit) {
                        total
                        hasNextPage
                        items {
                            id
                            title
                            description
                            tags {
                                value
                            }
                            previewUrl
                            ... on Image {
                                downloadUrl
                                width
                                height
                            }
                        }
                    }
                }
            }
        `;

        // Fetch assets from Frontify
        async function searchFrontifyAssets(libraryId, query, page = 1, limit = 50) {
            // Get API key from state or global fallback
            const apiKey = state.frontifyApiKey || window._frontifyApiKey;
            
            if (!apiKey) {
                throw new Error('Frontify API key not configured');
            }

            const response = await fetch(FRONTIFY_CONFIG.API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    query: SEARCH_ASSETS_QUERY,
                    variables: {
                        projectId: libraryId,
                        query: query,
                        page: page,
                        limit: limit
                    }
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your Frontify API key.');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // Transform Frontify asset to portrait format
        function transformAssetToPortrait(asset) {
            return {
                id: asset.id,
                name: asset.title || 'Unknown',
                role: asset.description || '',
                department: '',
                tags: asset.tags ? asset.tags.map(t => t.value) : [],
                image: asset.previewUrl || asset.downloadUrl,
                downloadUrl: asset.downloadUrl,
                width: asset.width,
                height: asset.height
            };
        }

        async function searchPortraits(query) {
            // Check for API key first
            const apiKey = state.frontifyApiKey || window._frontifyApiKey;
            if (!apiKey) {
                showPortraitStatus('Please configure your Frontify API key first', 'error');
                return;
            }

            const searchQuery = query || elements.portraitSearchInput.value.trim();
            
            if (!searchQuery) {
                showPortraitStatus('Please enter a search term', 'error');
                return;
            }

            state.portraitSearchQuery = searchQuery;
            state.portraitIsLoading = true;
            state.portraitHasSearched = true;
            state.portraitCurrentPage = 1;

            // Update UI
            elements.portraitEmptyState.style.display = 'none';
            elements.portraitNoResults.style.display = 'none';
            elements.portraitResultsLoading.style.display = 'flex';
            elements.portraitResultsGrid.innerHTML = '';
            elements.btnLoadMorePortraits.style.display = 'none';
            elements.portraitResultsCount.style.display = 'none';
            elements.portraitPreviewSection.classList.remove('visible');
            elements.btnClearPortraitSearch.style.display = 'flex';

            try {
                // Call Frontify API
                const data = await searchFrontifyAssets(LIBRARY_IDS.PEOPLE, searchQuery, 1, 50);

                if (data.errors) {
                    console.error('GraphQL errors:', data.errors);
                    throw new Error(data.errors[0]?.message || 'Search failed');
                }

                const items = data.data?.library?.assets?.items || [];
                const hasNext = data.data?.library?.assets?.hasNextPage || false;
                const total = data.data?.library?.assets?.total || items.length;

                // Transform assets to portrait format
                const results = items.map(transformAssetToPortrait);

                state.portraitSearchResults = results;
                state.portraitHasMore = hasNext;
                state.portraitTotalResults = total;

                renderPortraitResults(results);
                
                if (results.length === 0) {
                    elements.portraitNoResults.style.display = 'flex';
                } else {
                    showPortraitStatus(`Found ${total} result${total !== 1 ? 's' : ''}`, 'success');
                    elements.portraitResultsCount.textContent = `Showing ${results.length} of ${total}`;
                    elements.portraitResultsCount.style.display = 'block';
                    
                    if (hasNext) {
                        elements.btnLoadMorePortraits.style.display = 'flex';
                    }
                }

            } catch (error) {
                console.error('Portrait search error:', error);
                showPortraitStatus(`Search failed: ${error.message}`, 'error');
                elements.portraitNoResults.style.display = 'flex';
            } finally {
                state.portraitIsLoading = false;
                elements.portraitResultsLoading.style.display = 'none';
            }
        }

        async function loadMorePortraits() {
            if (state.portraitIsLoadingMore || !state.portraitHasMore) return;

            state.portraitIsLoadingMore = true;
            elements.btnLoadMorePortraits.disabled = true;
            elements.loadMoreSpinner.style.display = 'block';

            try {
                const nextPage = state.portraitCurrentPage + 1;
                const data = await searchFrontifyAssets(LIBRARY_IDS.PEOPLE, state.portraitSearchQuery, nextPage, 50);

                if (data.errors) {
                    throw new Error(data.errors[0]?.message || 'Failed to load more');
                }

                const items = data.data?.library?.assets?.items || [];
                const hasNext = data.data?.library?.assets?.hasNextPage || false;

                // Transform and append
                const newResults = items.map(transformAssetToPortrait);
                state.portraitSearchResults = [...state.portraitSearchResults, ...newResults];
                state.portraitCurrentPage = nextPage;
                state.portraitHasMore = hasNext;

                appendPortraitResults(newResults);
                
                elements.portraitResultsCount.textContent = `Showing ${state.portraitSearchResults.length} of ${state.portraitTotalResults}`;
                
                if (!hasNext) {
                    elements.btnLoadMorePortraits.style.display = 'none';
                }

            } catch (error) {
                console.error('Load more error:', error);
                showPortraitStatus('Failed to load more results', 'error');
            } finally {
                state.portraitIsLoadingMore = false;
                elements.btnLoadMorePortraits.disabled = false;
                elements.loadMoreSpinner.style.display = 'none';
            }
        }

        function renderPortraitResults(portraits) {
            elements.portraitResultsGrid.innerHTML = '';
            portraits.forEach(portrait => {
                const card = createPortraitCard(portrait);
                elements.portraitResultsGrid.appendChild(card);
            });
        }

        function appendPortraitResults(portraits) {
            portraits.forEach(portrait => {
                const card = createPortraitCard(portrait);
                elements.portraitResultsGrid.appendChild(card);
            });
        }

        function createPortraitCard(portrait) {
            const card = document.createElement('div');
            card.className = 'portrait-card';
            card.dataset.id = portrait.id;
            
            // Parse name and role from title (often formatted as "Name - Role" or just "Name")
            let displayName = portrait.name;
            let displayRole = portrait.role;
            
            if (portrait.name.includes(' - ')) {
                const parts = portrait.name.split(' - ');
                displayName = parts[0].trim();
                displayRole = parts[1]?.trim() || portrait.role;
            }
            
            card.innerHTML = `
                <img src="${portrait.image}" alt="${displayName}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%23f0f0f0%22 width=%22200%22 height=%22200%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2240%22>üë§</text></svg>'">
                <div class="portrait-card-overlay">
                    <div class="portrait-card-name">${displayName}</div>
                    ${displayRole ? `<div class="portrait-card-role">${displayRole}</div>` : ''}
                </div>
                <div class="selected-check"><i class="ms-Icon ms-Icon--CheckMark"></i></div>
            `;
            
            card.addEventListener('click', () => selectPortrait({...portrait, displayName, displayRole}, card));
            return card;
        }

        function selectPortrait(portrait, cardElement) {
            // Remove selection from other cards
            document.querySelectorAll('.portrait-card').forEach(c => c.classList.remove('selected'));
            
            // Select this card
            cardElement.classList.add('selected');
            state.selectedPortrait = portrait;

            // Show preview
            elements.portraitPreviewImage.src = portrait.image;
            elements.portraitMetadata.innerHTML = `
                <div class="portrait-metadata-name">${portrait.displayName || portrait.name}</div>
                ${portrait.displayRole ? `<div class="portrait-metadata-role">${portrait.displayRole}</div>` : ''}
                ${portrait.tags && portrait.tags.length > 0 ? `
                    <div class="portrait-metadata-tags">
                        ${portrait.tags.map(t => `<span class="portrait-metadata-tag">${t}</span>`).join('')}
                    </div>
                ` : ''}
            `;
            elements.portraitPreviewSection.classList.add('visible');

            // Fetch base64 for insertion
            fetchPortraitBase64(portrait.downloadUrl || portrait.image);
        }

        async function fetchPortraitBase64(imageUrl) {
            try {
                // Fetch image and convert to base64
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.portraitImageBase64 = reader.result.split(',')[1];
                };
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error('Error fetching portrait:', error);
                // Fallback: store URL for direct insertion
                state.portraitImageBase64 = null;
            }
        }

        async function insertPortrait() {
            if (!state.selectedPortrait) {
                showPortraitStatus('Please select a portrait first', 'error');
                return;
            }

            showPortraitStatus('Inserting image...', 'info');

            try {
                await PowerPoint.run(async (context) => {
                    const slide = context.presentation.getSelectedSlides().getItemAt(0);
                    
                    if (state.portraitImageBase64) {
                        // Insert from base64
                        slide.shapes.addImage(state.portraitImageBase64);
                    } else {
                        // Insert from URL
                        const image = slide.shapes.addImage(state.selectedPortrait.downloadUrl || state.selectedPortrait.image);
                    }
                    
                    await context.sync();
                });

                const name = state.selectedPortrait.displayName || state.selectedPortrait.name;
                showPortraitStatus(`Inserted: ${name}`, 'success');
            } catch (error) {
                console.error('Insert portrait error:', error);
                showPortraitStatus('Failed to insert portrait. Please try again.', 'error');
            }
        }

        function clearPortraitSearch() {
            state.portraitSearchQuery = '';
            state.portraitSearchResults = [];
            state.portraitHasSearched = false;
            state.selectedPortrait = null;
            state.portraitImageBase64 = null;
            state.portraitTotalResults = 0;

            elements.portraitSearchInput.value = '';
            elements.portraitResultsGrid.innerHTML = '';
            elements.portraitEmptyState.style.display = 'flex';
            elements.portraitNoResults.style.display = 'none';
            elements.btnLoadMorePortraits.style.display = 'none';
            elements.portraitResultsCount.style.display = 'none';
            elements.portraitPreviewSection.classList.remove('visible');
            elements.btnClearPortraitSearch.style.display = 'none';
            elements.portraitTags.forEach(t => t.classList.remove('active'));
        }

        function showPortraitStatus(message, type) {
            const statusEl = elements.portraitStatusMessage;
            const icon = type === 'success' ? 'CheckMark' : type === 'error' ? 'ErrorBadge' : 'Info';
            statusEl.innerHTML = `<i class="ms-Icon ms-Icon--${icon}"></i><span>${message}</span>`;
            statusEl.className = `status-message visible ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => statusEl.classList.remove('visible'), 3000);
            }
        }

        // ======================
        // SlideWiki Functions
        // ======================
        async function connectToSharePoint() {
            elements.btnConnectSharePoint.disabled = true;
            elements.btnConnectSharePoint.innerHTML = '<div class="spinner"></div><span>Connecting...</span>';
            
            try {
                // For demo: simulate connection
                // In production, this would use Microsoft Graph API with MSAL authentication
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                state.sharepointConnected = true;
                elements.sharepointStatus.textContent = 'Connected';
                elements.sharepointStatus.className = 'api-key-status connected';
                elements.btnConnectSharePoint.innerHTML = '<i class="ms-Icon ms-Icon--CheckMark"></i><span>Connected</span>';
                elements.btnConnectSharePoint.style.background = 'var(--success)';
                elements.btnLoadSlides.disabled = !elements.sharepointPath.value.trim();
                
                showSlidewikiStatus('Connected to Microsoft 365!', 'success');
            } catch (error) {
                showSlidewikiStatus('Connection failed: ' + error.message, 'error');
                elements.btnConnectSharePoint.innerHTML = '<i class="ms-Icon ms-Icon--PlugConnected"></i><span>Connect to Microsoft 365</span>';
            }
            
            elements.btnConnectSharePoint.disabled = false;
        }

        async function loadSharePointSlides() {
            const folderUrl = elements.sharepointPath.value.trim();
            if (!folderUrl) return;
            
            elements.btnLoadSlides.disabled = true;
            elements.slidePreviewLoading.style.display = 'flex';
            elements.slidePreviewGrid.innerHTML = '';
            showSlidewikiStatus('Loading presentations...', 'info');
            
            try {
                // For demo: simulate loading files
                // In production, this would call Microsoft Graph API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Demo data - replace with actual Graph API call
                const demoFiles = [
                    { name: 'The strategy house.pptx', slides: 8, modified: '2025-01-29', id: '7D017D76-286F-40BE-9421-DA327AA79B82' },
                    { name: 'Company Overview.pptx', slides: 12, modified: '2025-01-15', id: 'demo-1' },
                    { name: 'Q4 Report.pptx', slides: 6, modified: '2025-01-10', id: 'demo-2' }
                ];
                
                state.sharepointFiles = demoFiles;
                elements.slidesListSection.style.display = 'block';
                
                // Render file list
                elements.slidesList.innerHTML = demoFiles.map((file, index) => `
                    <div class="slide-file-item" data-index="${index}">
                        <i class="ms-Icon ms-Icon--PowerPointDocument"></i>
                        <div class="slide-file-info">
                            <div class="slide-file-name">${file.name}</div>
                            <div class="slide-file-meta">${file.slides} slides ‚Ä¢ Modified ${file.modified}</div>
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.slide-file-item').forEach(item => {
                    item.addEventListener('click', () => loadPresentationSlides(parseInt(item.dataset.index)));
                });
                
                showSlidewikiStatus('Found ' + demoFiles.length + ' presentations', 'success');
            } catch (error) {
                showSlidewikiStatus('Failed to load: ' + error.message, 'error');
            }
            
            elements.btnLoadSlides.disabled = false;
            elements.slidePreviewLoading.style.display = 'none';
        }

        async function loadPresentationSlides(fileIndex) {
            const file = state.sharepointFiles[fileIndex];
            if (!file) return;
            
            // Highlight selected file
            document.querySelectorAll('.slide-file-item').forEach((item, i) => {
                item.classList.toggle('selected', i === fileIndex);
            });
            
            elements.slidePreviewLoading.style.display = 'flex';
            state.currentPresentation = file;
            state.selectedSlides = [];
            
            try {
                // For demo: simulate loading slide thumbnails
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Generate demo slide thumbnails with realistic themes
                const slideThemes = [
                    { title: 'Title', color: '#1a365d', subtitle: 'The Strategy House' },
                    { title: 'Agenda', color: '#2c5282', subtitle: 'Overview' },
                    { title: 'Vision', color: '#2b6cb0', subtitle: 'Our Direction' },
                    { title: 'Strategy', color: '#3182ce', subtitle: 'Key Pillars' },
                    { title: 'Goals', color: '#4299e1', subtitle: '2025 Targets' },
                    { title: 'Roadmap', color: '#63b3ed', subtitle: 'Timeline' },
                    { title: 'Team', color: '#90cdf4', subtitle: 'Who We Are' },
                    { title: 'Q&A', color: '#bee3f8', subtitle: 'Questions' }
                ];
                
                const slides = slideThemes.slice(0, file.slides).map((theme, i) => ({
                    index: i + 1,
                    ...theme
                }));
                
                elements.slidePreviewGrid.innerHTML = slides.map(slide => `
                    <div class="slide-thumb" data-slide="${slide.index}">
                        <div style="width:100%;height:100%;background:linear-gradient(135deg, ${slide.color}, ${slide.color}dd);display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;padding:8px;text-align:center;">
                            <div style="font-size:14px;font-weight:bold;">${slide.title}</div>
                            <div style="font-size:9px;opacity:0.8;margin-top:2px;">${slide.subtitle}</div>
                        </div>
                        <span class="slide-number">${slide.index}</span>
                        <span class="slide-check"><i class="ms-Icon ms-Icon--CheckMark"></i></span>
                    </div>
                `).join('');
                
                // Add click handlers for slide selection
                document.querySelectorAll('.slide-thumb').forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        const slideNum = parseInt(thumb.dataset.slide);
                        thumb.classList.toggle('selected');
                        
                        if (thumb.classList.contains('selected')) {
                            if (!state.selectedSlides.includes(slideNum)) {
                                state.selectedSlides.push(slideNum);
                            }
                        } else {
                            state.selectedSlides = state.selectedSlides.filter(s => s !== slideNum);
                        }
                        
                        // Show/hide insert button
                        elements.slideActions.style.display = state.selectedSlides.length > 0 ? 'flex' : 'none';
                        elements.btnInsertSlide.innerHTML = `<i class="ms-Icon ms-Icon--AddTo"></i><span>Insert ${state.selectedSlides.length} Slide${state.selectedSlides.length > 1 ? 's' : ''}</span>`;
                    });
                });
                
                showSlidewikiStatus('Loaded ' + file.slides + ' slides from ' + file.name, 'success');
            } catch (error) {
                showSlidewikiStatus('Failed to load slides: ' + error.message, 'error');
            }
            
            elements.slidePreviewLoading.style.display = 'none';
        }

        async function insertSelectedSlides() {
            if (state.selectedSlides.length === 0) return;
            
            elements.btnInsertSlide.disabled = true;
            elements.btnInsertSlide.innerHTML = '<div class="spinner"></div><span>Inserting...</span>';
            
            try {
                // For demo: simulate inserting slides
                // In production: download slides via Graph API and insert using PowerPoint API
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                showSlidewikiStatus(`Inserted ${state.selectedSlides.length} slide(s) from ${state.currentPresentation.name}!`, 'success');
                
                // Clear selection
                state.selectedSlides = [];
                document.querySelectorAll('.slide-thumb.selected').forEach(thumb => {
                    thumb.classList.remove('selected');
                });
                elements.slideActions.style.display = 'none';
                
            } catch (error) {
                showSlidewikiStatus('Failed to insert: ' + error.message, 'error');
            }
            
            elements.btnInsertSlide.disabled = false;
            elements.btnInsertSlide.innerHTML = '<i class="ms-Icon ms-Icon--AddTo"></i><span>Insert Selected Slides</span>';
        }

        function showSlidewikiStatus(message, type) {
            const icon = type === 'success' ? 'CheckMark' : type === 'error' ? 'ErrorBadge' : 'Info';
            elements.slidewikiStatusMessage.innerHTML = `<i class="ms-Icon ms-Icon--${icon}"></i><span>${message}</span>`;
            elements.slidewikiStatusMessage.className = `status-message visible ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => elements.slidewikiStatusMessage.classList.remove('visible'), 4000);
            }
        }

        // ======================
        // CS Request
        // ======================
        function submitCSRequest() {
            // Gather form data
            const presentation = document.querySelector('input[name="presentation"]:checked');
            const design = Array.from(document.querySelectorAll('input[name="design"]:checked')).map(cb => cb.value);
            const web = Array.from(document.querySelectorAll('input[name="web"]:checked')).map(cb => cb.value);
            const video = Array.from(document.querySelectorAll('input[name="video"]:checked')).map(cb => cb.value);
            const brand = document.querySelector('input[name="brand"]:checked');
            
            const projectTitle = elements.csProjectTitle.value.trim();
            const description = elements.csDescription.value.trim();
            const deadline = elements.csDeadline.value;
            
            // Validation
            if (!presentation && design.length === 0 && web.length === 0 && video.length === 0 && !brand) {
                showCSStatus('Please select at least one service type.', 'error');
                return;
            }
            
            if (!projectTitle) {
                showCSStatus('Please enter a project title.', 'error');
                return;
            }
            
            // Compile request data
            const requestData = {
                services: {
                    presentation: presentation ? presentation.value : null,
                    design: design,
                    web: web,
                    video: video,
                    brand: brand ? brand.value : null
                },
                projectTitle: projectTitle,
                description: description,
                deadline: deadline,
                submittedAt: new Date().toISOString()
            };
            
            console.log('CS Request submitted:', requestData);
            
            // Show success message
            showCSStatus('Request submitted successfully! The Creative Studio team will contact you soon.', 'success');
            
            // Clear form
            document.querySelectorAll('.cs-form input[type="radio"]').forEach(r => r.checked = false);
            document.querySelectorAll('.cs-form input[type="checkbox"]').forEach(c => c.checked = false);
            elements.csProjectTitle.value = '';
            elements.csDescription.value = '';
            elements.csDeadline.value = '';
            
            // In production, you would send this to your backend or create a SharePoint list item
            // Example: await fetch('https://your-api.com/cs-requests', { method: 'POST', body: JSON.stringify(requestData) });
        }

        function showCSStatus(message, type) {
            const statusEl = elements.csStatusMessage;
            const icon = type === 'success' ? 'CheckMark' : type === 'error' ? 'ErrorBadge' : 'Info';
            statusEl.innerHTML = `<i class="ms-Icon ms-Icon--${icon}"></i><span>${message}</span>`;
            statusEl.className = `status-message visible ${type}`;
            
            if (type === 'success') {
                setTimeout(() => statusEl.classList.remove('visible'), 5000);
            }
        }

        // ======================
        // Feedback
        // ======================
        function submitFeedback() {
            const feedback = elements.feedbackText.value.trim();
            const type = elements.feedbackType.value;
            
            if (!feedback) {
                alert('Please enter your feedback before submitting.');
                return;
            }
            
            // For now, just show confirmation. You could integrate with a backend or email service.
            console.log('Feedback submitted:', { type, feedback });
            alert('Thank you for your feedback! üéâ');
            elements.feedbackText.value = '';
        }

        // ======================
        // UI Helpers
        // ======================
        function updateGenerateButtons() {
            const hasApiKey = (state.apiKey && state.apiKey.length > 0) || (window._openaiApiKey && window._openaiApiKey.length > 0);
            
            elements.btnGenerate.disabled = !elements.promptInput.value.trim() || !hasApiKey || state.isGenerating;
            elements.btnGenerateIcon.disabled = !elements.iconSubjectInput.value.trim() || !hasApiKey || state.isGenerating;
            // Note: Portraits tab uses search, not AI generation
            
            const btnText = state.isGenerating ? '<div class="spinner"></div><span>Generating...</span>' : '<i class="ms-Icon ms-Icon--Rocket"></i><span>Generate</span>';
            if (state.isGenerating) {
                elements.btnGenerate.innerHTML = btnText;
                elements.btnGenerateIcon.innerHTML = btnText;
            } else {
                elements.btnGenerate.innerHTML = '<i class="ms-Icon ms-Icon--Rocket"></i><span>Generate Image</span>';
                elements.btnGenerateIcon.innerHTML = '<i class="ms-Icon ms-Icon--Rocket"></i><span>Generate Icon</span>';
            }
        }

        function showStatus(message, type, tab) {
            let statusEl;
            if (tab === 'images') statusEl = elements.statusMessage;
            else if (tab === 'icons') statusEl = elements.iconStatusMessage;
            else if (tab === 'portraits') statusEl = elements.portraitStatusMessage;
            else return;

            const icon = type === 'success' ? 'CheckMark' : type === 'error' ? 'ErrorBadge' : 'Info';
            statusEl.innerHTML = `<i class="ms-Icon ms-Icon--${icon}"></i><span>${message}</span>`;
            statusEl.className = `status-message visible ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => statusEl.classList.remove('visible'), 3000);
            }
        }
    </script>
</body>
</html>
